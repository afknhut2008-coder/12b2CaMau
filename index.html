<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>12B2 - Cộng Đồng & Tuổi Thơ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS CHUNG VÀ HIỆU ỨNG MỚI */
        :root { 
            --primary: #4CAF50; /* Xanh lá cây tươi sáng (phù hợp tuổi thơ/game) */
            --secondary: #FFC107; /* Vàng hổ phách */
            --bg: #f7f9fc; /* Nền trắng xanh nhạt, hiện đại */
            --white: #ffffff; 
            --text: #333; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            --dino-bg: #e0e0e0; /* Màu nền cho game */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { 
            background: var(--bg); 
            padding-bottom: 70px; 
            color: var(--text); 
            transition: background 0.5s;
        }
        .navbar { 
            background: var(--primary); 
            padding: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
        }
        .navbar a { color: white; text-decoration: none; margin-left: 15px; font-size: 0.9rem; transition: opacity 0.3s; }
        .navbar a:hover { opacity: 0.8; }
        
        /* LANGUAGE SWITCH */
        #lang-switch { 
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 15px; 
            padding: 5px 10px; 
            cursor: pointer; 
            font-size: 0.8rem;
        }
        
        .container { max-width: 600px; margin: 15px auto; padding: 0 10px; }
        .card { 
            background: var(--white); 
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        
        /* TAB NAVIGATION */
        .tab-nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px 0;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .tab-btn {
            background: none;
            border: none;
            color: #777;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            transition: color 0.3s, background 0.3s;
        }
        .tab-btn.active {
            color: white;
            background: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-content { animation: fadeIn 0.5s; }
        
        /* GAME SECTION STYLES */
        .game-wrapper {
            background: var(--dino-bg);
            border: 5px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .game-canvas { border: 1px solid #999; display: block; margin: 10px auto; }

        /* QUIZ STYLES (Dùng màu sắc mới) */
        .quiz-card h3 { color: var(--primary); }
        .opt-btn:not(:disabled):hover { 
            background: #eaf8ea; /* Màu nền xanh nhạt khi hover */
            border-color: var(--primary); 
            transform: translateX(5px);
        }
        .next-btn { background: var(--secondary); color: #333; font-weight: bold; }
        
        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body onload="initApp()">

    <div class="navbar">
        <div>12B2 <span data-i18n="community">Cộng Đồng</span></div>
        <div style="display: flex; align-items: center;">
            <a href="https://www.tiktok.com/@12b2thptcamau?is_from_webapp=1&sender_device=pc" target="_blank" style="font-size: 1.2rem;"><i class="fab fa-tiktok"></i> TikTok</a>
            <div id="lang-switch" onclick="toggleLanguage()">VI / EN</div>
        </div>
    </div>

    <div class="container">

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="social" onclick="showTab('social')" data-i18n="social_tab">Social & Quiz</button>
            <button class="tab-btn" data-tab="games" onclick="showTab('games')" data-i18n="game_tab">Games (Tuổi Thơ)</button>
        </div>

        <div id="social" class="tab-content">

            <h3 style="color: #555;"><i class="fas fa-comments"></i> <span data-i18n="chat_title">Góc Chat Ẩn Danh</span></h3>
            <div class="create-message card">
                <textarea id="message-text" rows="3" data-i18n-placeholder="chat_placeholder" placeholder="Gửi tin nhắn ẩn danh cho cả lớp..."></textarea>
                <div class="msg-actions">
                    <button id="btn-send-msg" class="btn-send" onclick="sendMessage()" data-i18n="send_msg">Gửi tin nhắn</button>
                </div>
            </div>
            <div id="message-list">
                <div style="text-align: center; color: #888; margin-top: 20px;" data-i18n="loading_msg">Đang tải tin nhắn...</div>
            </div>

            <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

            <h3 style="color: #555;"><i class="fas fa-brain"></i> <span data-i18n="quiz_title">Thử Thách Đố Vui</span></h3>
            
            <div id="name-input-section" class="card">
                <h4 data-i18n="name_prompt">Bắt đầu Quiz! Vui lòng nhập tên (để lên BXH):</h4>
                <input type="text" id="user-name-input" data-i18n-placeholder="name_placeholder" placeholder="Tên của bạn (ví dụ: Nam Kế Toán)">
                <button onclick="saveUserName()" data-i18n="start_quiz">Bắt đầu Quiz</button>
            </div>

            <div id="quiz-section" style="display: none;">
                <div class="quiz-card card">
                    <div class="quiz-stat"><span data-i18n="welcome">Chào mừng</span>, <span id="current-user-display" style="color: var(--primary); font-weight: bold;"></span>!</div>
                    <div class="quiz-stat"><span data-i18n="completed">Đã hoàn thành</span>: <span id="done-count">0</span> <span data-i18n="q_count">câu</span> | <span data-i18n="score">Điểm hiện tại</span>: <span id="current-score">0</span></div>
                    
                    <div id="quiz-content">
                        <div id="q-category" style="display: inline-block; background: #eee; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; margin-bottom: 10px;" data-i18n="topic">Chủ đề</div>
                        <div id="q-text" class="question-box"></div>
                        <div id="options" class="options-grid"></div>
                        <button id="next-btn" class="next-btn" onclick="loadNextQuestion()" data-i18n="next_q">Câu tiếp theo <i class="fas fa-arrow-right"></i></button>
                    </div>

                    <div id="quiz-complete" style="display: none; padding: 30px;">
                        <i class="fas fa-trophy" style="font-size: 3rem; color: gold; margin-bottom: 15px;"></i>
                        <h3 data-i18n="quiz_done_h3">Hoàn thành!</h3>
                        <p><span data-i18n="final_score_p">Tổng điểm của bạn</span>: <strong id="final-score-display"></strong>. <span data-i18n="sending_rank">Đang gửi kết quả lên BXH...</span></p>
                        <button onclick="resetQuiz()" data-i18n="play_again" style="margin-top: 15px; padding: 10px 20px; border:1px solid #ddd; background:white; border-radius: 20px; cursor:pointer;">Làm lại</button>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

            <h3 style="color: #555;"><i class="fas fa-plus-circle"></i> <span data-i18n="create_q_title">Tạo Câu Hỏi Mới</span></h3>
            <div id="create-question-section" class="card">
                <h4 style="margin-bottom: 10px;" data-i18n="contribute_q">Đóng góp Quiz (sẽ được Admin duyệt):</h4>
                <input type="text" id="q-text-input" data-i18n-placeholder="q_content_ph" placeholder="Nội dung Câu hỏi"><br>
                <input type="text" id="q-ans-0" data-i18n-placeholder="ans_a_ph" placeholder="Đáp án A"><br>
                <input type="text" id="q-ans-1" data-i18n-placeholder="ans_b_ph" placeholder="Đáp án B"><br>
                <input type="text" id="q-ans-2" data-i18n-placeholder="ans_c_ph" placeholder="Đáp án C"><br>
                <input type="text" id="q-ans-3" data-i18n-placeholder="ans_d_ph" placeholder="Đáp án D"><br>
                <select id="q-correct-select">
                    <option value="-1" data-i18n="select_correct_ans">Chọn Đáp án Đúng</option>
                    <option value="0" data-i18n="ans_a_correct">Đáp án A là đúng</option>
                    <option value="1" data-i18n="ans_b_correct">Đáp án B là đúng</option>
                    <option value="2" data-i18n="ans_c_correct">Đáp án C là đúng</option>
                    <option value="3" data-i18n="ans_d_correct">Đáp án D là đúng</option>
                </select>
                <input type="text" id="q-cat-input" data-i18n-placeholder="category_ph" placeholder="Chủ đề (ví dụ: Toán, Lý)">
                <button class="btn-send" style="width: 100%;" onclick="submitUserQuestion()" data-i18n="submit_q">Gửi đóng góp</button>
            </div>
            
            <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

            <h3 style="color: #555;"><i class="fas fa-trophy"></i> <span data-i18n="leaderboard_title">Bảng Xếp Hạng (Top 10)</span></h3>
            <div id="leaderboard-section" class="card">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th data-i18n="rank">Hạng</th>
                            <th data-i18n="name">Tên</th>
                            <th data-i18n="score">Điểm</th>
                            <th data-i18n="date">Ngày chơi</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" style="text-align: center;" data-i18n="loading_rank">Đang tải bảng xếp hạng...</td></tr>
                    </tbody>
                </table>
            </div>

        </div> <div id="games" class="tab-content" style="display: none;">
            <h3 style="color: #555; margin-bottom: 20px;"><i class="fas fa-gamepad"></i> <span data-i18n="game_h3">Khu Vực Trò Chơi Tuổi Thơ</span></h3>
            
            <div class="game-wrapper card">
                <h4 data-i18n="dino_title">Chrome Dino Run (Nhấn SPACE)</h4>
                <canvas id="dino-canvas" class="game-canvas" width="450" height="150" style="border: 2px dashed #999;"></canvas>
            </div>

            <div class="game-wrapper card">
                <h4 data-i18n="flappy_title">Flappy Bird (Nhấn SPACE hoặc CLICK)</h4>
                <canvas id="flappy-canvas" class="game-canvas" width="450" height="300" style="border: 2px dashed #999;"></canvas>
            </div>
            
        </div> </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    
    <script>
        // *** DINO RUN (TỐI GIẢN) ***
        const DINO_CANVAS = document.getElementById('dino-canvas');
        const DINO_CTX = DINO_CANVAS ? DINO_CANVAS.getContext('2d') : null;
        let isDinoGameRunning = false;

        function drawDinoInstruction() {
            if (!DINO_CTX) return;
            DINO_CTX.clearRect(0, 0, DINO_CANVAS.width, DINO_CANVAS.height);
            DINO_CTX.fillStyle = '#777';
            DINO_CTX.font = '16px Arial';
            DINO_CTX.textAlign = 'center';
            DINO_CTX.fillText('Bấm SPACE để BẮT ĐẦU', DINO_CANVAS.width / 2, DINO_CANVAS.height / 2);
        }

        function initDinoGame() {
            if (DINO_CANVAS && DINO_CTX) drawDinoInstruction();
            // Đây là nơi bạn sẽ nhúng thư viện game Dino thực tế nếu cần.
            // Để giữ code đơn giản, tôi chỉ để phần khởi tạo canvas.
        }
        
        // *** FLAPPY BIRD (TỐI GIẢN) ***
        const FLAPPY_CANVAS = document.getElementById('flappy-canvas');
        const FLAPPY_CTX = FLAPPY_CANVAS ? FLAPPY_CANVAS.getContext('2d') : null;
        let isFlappyGameRunning = false;

        function drawFlappyInstruction() {
             if (!FLAPPY_CTX) return;
            FLAPPY_CTX.clearRect(0, 0, FLAPPY_CANVAS.width, FLAPPY_CANVAS.height);
            FLAPPY_CTX.fillStyle = '#777';
            FLAPPY_CTX.font = '16px Arial';
            FLAPPY_CTX.textAlign = 'center';
            FLAPPY_CTX.fillText('Bấm SPACE hoặc CLICK để BẮT ĐẦU', FLAPPY_CANVAS.width / 2, FLAPPY_CANVAS.height / 2);
        }

        function initFlappyGame() {
            if (FLAPPY_CANVAS && FLAPPY_CTX) drawFlappyInstruction();
            // Tương tự Dino, chỉ là canvas placeholder.
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDinoGame();
            initFlappyGame();
        });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- DỮ LIỆU ĐA NGÔN NGỮ ---
        const translations = {
            'vi': {
                'community': 'Cộng Đồng',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Tuổi Thơ)',
                'chat_title': 'Góc Chat Ẩn Danh',
                'chat_placeholder': 'Gửi tin nhắn ẩn danh cho cả lớp...',
                'send_msg': 'Gửi tin nhắn',
                'loading_msg': 'Đang tải tin nhắn...',
                'quiz_title': 'Thử Thách Đố Vui',
                'name_prompt': 'Bắt đầu Quiz! Vui lòng nhập tên (để lên BXH):',
                'name_placeholder': 'Tên của bạn (ví dụ: Nam Kế Toán)',
                'start_quiz': 'Bắt đầu Quiz',
                'welcome': 'Chào mừng',
                'completed': 'Đã hoàn thành',
                'q_count': 'câu',
                'score': 'Điểm hiện tại',
                'topic': 'Chủ đề',
                'next_q': 'Câu tiếp theo',
                'quiz_done_h3': 'Hoàn thành!',
                'final_score_p': 'Tổng điểm của bạn',
                'sending_rank': 'Đang gửi kết quả lên BXH...',
                'play_again': 'Làm lại',
                'create_q_title': 'Tạo Câu Hỏi Mới',
                'contribute_q': 'Đóng góp Quiz (sẽ được Admin duyệt):',
                'q_content_ph': 'Nội dung Câu hỏi',
                'ans_a_ph': 'Đáp án A', 'ans_b_ph': 'Đáp án B', 'ans_c_ph': 'Đáp án C', 'ans_d_ph': 'Đáp án D',
                'select_correct_ans': 'Chọn Đáp án Đúng',
                'ans_a_correct': 'Đáp án A là đúng', 'ans_b_correct': 'Đáp án B là đúng', 'ans_c_correct': 'Đáp án C là đúng', 'ans_d_correct': 'Đáp án D là đúng',
                'category_ph': 'Chủ đề (ví dụ: Toán, Lý)',
                'submit_q': 'Gửi đóng góp',
                'leaderboard_title': 'Bảng Xếp Hạng (Top 10)',
                'rank': 'Hạng', 'name': 'Tên', 'date': 'Ngày chơi',
                'loading_rank': 'Đang tải bảng xếp hạng...',
                'game_h3': 'Khu Vực Trò Chơi Tuổi Thơ',
                'dino_title': 'Chrome Dino Run (Nhấn SPACE)',
                'flappy_title': 'Flappy Bird (Nhấn SPACE hoặc CLICK)',
                'anonymous': 'Ẩn danh'
            },
            'en': {
                'community': 'Community',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Childhood)',
                'chat_title': 'Anonymous Chat Corner',
                'chat_placeholder': 'Send an anonymous message to the class...',
                'send_msg': 'Send Message',
                'loading_msg': 'Loading messages...',
                'quiz_title': 'Quiz Challenge',
                'name_prompt': 'Start Quiz! Please enter your name (for Leaderboard):',
                'name_placeholder': 'Your name (e.g., John Doe)',
                'start_quiz': 'Start Quiz',
                'welcome': 'Welcome',
                'completed': 'Completed',
                'q_count': 'questions',
                'score': 'Current Score',
                'topic': 'Topic',
                'next_q': 'Next Question',
                'quiz_done_h3': 'Finished!',
                'final_score_p': 'Your total score',
                'sending_rank': 'Submitting score to Leaderboard...',
                'play_again': 'Play Again',
                'create_q_title': 'Create New Question',
                'contribute_q': 'Contribute Quiz (To be approved by Admin):',
                'q_content_ph': 'Question Content',
                'ans_a_ph': 'Answer A', 'ans_b_ph': 'Answer B', 'ans_c_ph': 'Answer C', 'ans_d_ph': 'Answer D',
                'select_correct_ans': 'Select Correct Answer',
                'ans_a_correct': 'Answer A is correct', 'ans_b_correct': 'Answer B is correct', 'ans_c_correct': 'Answer C is correct', 'ans_d_correct': 'Answer D is correct',
                'category_ph': 'Category (e.g., Math, Physics)',
                'submit_q': 'Submit Contribution',
                'leaderboard_title': 'Leaderboard (Top 10)',
                'rank': 'Rank', 'name': 'Name', 'date': 'Play Date',
                'loading_rank': 'Loading leaderboard...',
                'game_h3': 'Childhood Games Zone',
                'dino_title': 'Chrome Dino Run (Press SPACE)',
                'flappy_title': 'Flappy Bird (Press SPACE or CLICK)',
                'anonymous': 'Anonymous'
            }
        };

        let currentLang = localStorage.getItem('appLang') || 'vi';

        window.toggleLanguage = function() {
            currentLang = currentLang === 'vi' ? 'en' : 'vi';
            localStorage.setItem('appLang', currentLang);
            applyLanguage(currentLang);
        }

        function applyLanguage(lang) {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = translations[lang][key];
            });

            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[lang][key];
            });
            
            // Cập nhật lại các danh sách động (như tin nhắn)
            // Cập nhật lại Bảng xếp hạng
            loadLeaderboard(); 
            onSnapshot(query(chatRef, orderBy("createdAt", "desc"), limit(10)), updateChatList);
        }
        
        // --- LOGIC TAB CON ---
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
        }

        // ⚠️ THAY THÔNG TIN CỦA BẠN VÀO ĐÂY (VUI LÒNG DÙNG THÔNG TIN CỦA BẠN)
        const firebaseConfig = {
            apiKey: "AIzaSyBSqEO-mi650wMN2gwVac3nwLFtg4TTX80", 
            authDomain: "b2-6431c.firebaseapp.com",
            projectId: "b2-6431c",
            storageBucket: "b2-6431c.appspot.com",
            messagingSenderId: "164059778488",
            appId: "1:164059778488:web:9eca97e23ab644df48534d",
            measurementId: "G-19QWD4RCYC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // CÁC COLLECTIONS SỬ DỤNG
        const chatRef = collection(db, "anonymous_messages");
        const quizRef = collection(db, "quiz_questions");
        const submittedQuestionsRef = collection(db, "user_submitted_questions"); 
        const leaderboardRef = collection(db, "quiz_leaderboard"); 

        // BIẾN TOÀN CỤC QUIZ
        let availableQuestions = [];
        let fullQuestionBank = [];
        let currentScore = 0;
        let questionsAttempted = 0;
        let currentUserName = localStorage.getItem('userName12B2') || null;

        // --- HÀM KHỞI TẠO CHUNG (CHẠY KHI TẢI TRANG) ---
        window.initApp = function() {
            applyLanguage(currentLang);
            loadLeaderboard();
            if (currentUserName) {
                document.getElementById('current-user-display').innerText = currentUserName;
                document.getElementById('name-input-section').style.display = 'none';
                document.getElementById('quiz-section').style.display = 'block';
                initQuiz();
            } else {
                document.getElementById('name-input-section').style.display = 'block';
                document.getElementById('quiz-section').style.display = 'none';
            }
        }

        // --- HÀM XỬ LÝ TÊN NGƯỜI DÙNG ---
        window.saveUserName = function() {
            const nameInput = document.getElementById('user-name-input').value.trim();
            if (nameInput.length < 2 || nameInput.length > 20) {
                alert(currentLang === 'vi' ? "Tên phải từ 2 đến 20 ký tự!" : "Name must be between 2 and 20 characters!");
                return;
            }
            currentUserName = nameInput;
            localStorage.setItem('userName12B2', currentUserName);
            document.getElementById('current-user-display').innerText = currentUserName;
            document.getElementById('name-input-section').style.display = 'none';
            document.getElementById('quiz-section').style.display = 'block';
            initQuiz();
        }

        // --- PHẦN 1: GỬI VÀ HIỂN THỊ TIN NHẮN ẨN DANH ---
        window.sendMessage = async function() {
            const messageText = document.getElementById('message-text').value;
            const btn = document.getElementById('btn-send-msg');
            if (!messageText.trim()) return;

            btn.disabled = true;
            btn.innerText = currentLang === 'vi' ? "Đang gửi..." : "Sending...";

            try {
                await addDoc(chatRef, {
                    text: messageText,
                    createdAt: serverTimestamp(),
                    author: translations[currentLang]['anonymous'] // Dùng biến ngôn ngữ
                });
                document.getElementById('message-text').value = '';
            } catch (error) {
                console.error("Lỗi gửi tin nhắn:", error);
                alert((currentLang === 'vi' ? "Lỗi gửi tin nhắn: " : "Error sending message: ") + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = translations[currentLang]['send_msg'];
            }
        }
        
        const updateChatList = (snapshot) => {
            const list = document.getElementById("message-list");
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const msg = doc.data();
                const date = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : (currentLang === 'vi' ? 'Vừa xong' : 'Just now');
                const authorDisplay = msg.author || translations[currentLang]['anonymous'];
                list.innerHTML += `<div class="post card"><div class="post-header"><span class="post-author"><i class="fas fa-user-secret"></i> ${authorDisplay}</span><span>${date}</span></div><div style="font-size: 1rem; line-height: 1.5;">${msg.text}</div></div>`;
            });
        };

        onSnapshot(query(chatRef, orderBy("createdAt", "desc"), limit(10)), updateChatList);

        // --- PHẦN 2: QUIZ VỚI ĐIỂM SỐ & TÊN (CHỈ DÙNG FIRESTORE) ---
        
        window.initQuiz = async function() {
            currentScore = 0;
            questionsAttempted = 0;
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('quiz-content').style.display = 'block';
            document.getElementById('quiz-complete').style.display = 'none';
            document.getElementById('q-text').innerText = currentLang === 'vi' ? "Đang tải câu hỏi từ cộng đồng..." : "Loading questions from community..."; 
            
            // Tải câu hỏi từ Firestore 
            if (fullQuestionBank.length === 0) {
                try {
                    const querySnapshot = await getDocs(quizRef);
                    querySnapshot.forEach((doc) => { fullQuestionBank.push({ id: doc.id, ...doc.data() }); });
                    if (fullQuestionBank.length === 0) {
                        document.getElementById('q-text').innerText = currentLang === 'vi' ? "Chưa có câu hỏi nào được Admin duyệt. Vui lòng đóng góp!" : "No questions have been approved by Admin. Please contribute!";
                        document.getElementById('options').innerHTML = '';
                        return;
                    }
                } catch (e) {
                    document.getElementById('q-text').innerText = currentLang === 'vi' ? "Lỗi kết nối hoặc chưa có câu hỏi. Vui lòng kiểm tra Rules Firestore." : "Connection error or no questions. Check Firestore Rules.";
                    return;
                }
            }

            // Lấy ID các câu đã làm thành công
            const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]').map(item => item.id) || [];
            availableQuestions = fullQuestionBank.filter(q => !doneIds.includes(q.id));

            if(availableQuestions.length === 0) {
                // Nếu hết câu hỏi, reset trạng thái đã làm (cho phép chơi lại toàn bộ)
                localStorage.removeItem('quiz_done_ids');
                availableQuestions = fullQuestionBank;
            } 
            loadNextQuestion();
        }

        // Logic tải câu hỏi, kiểm tra đáp án, lưu điểm và leaderboard giữ nguyên
        // ... (phần code này giữ nguyên từ bản trước, chỉ thêm phần đa ngôn ngữ vào alert và text tĩnh)
        
        window.checkAnswer = function(btn, qData, selectedIdx) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true); 

            questionsAttempted++;

            if(selectedIdx === qData.c) {
                btn.classList.add('correct');
                currentScore += 10; 
                
                const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]') || [];
                if(!doneIds.some(item => item.id === qData.id)) {
                    doneIds.push({ id: qData.id, date: new Date().getTime() });
                    localStorage.setItem('quiz_done_ids', JSON.stringify(doneIds));
                }

            } else {
                btn.classList.add('wrong');
                allBtns[qData.c].classList.add('correct'); 
            }
            
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('next-btn').style.display = 'inline-block';
            
            availableQuestions = availableQuestions.filter(q => q.id !== qData.id);
        }

        function endQuizAndSubmitScore() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('quiz-complete').style.display = 'block';
            document.getElementById('final-score-display').innerText = currentScore;
            
            saveScoreToLeaderboard(currentScore, questionsAttempted);
        }

        window.loadLeaderboard = async function() {
            const q = query(leaderboardRef, orderBy("score", "desc"), limit(10)); 
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : 'N/A';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${rank++}</td>
                        <td>${data.name}</td>
                        <td>${data.score}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });

            if (snapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${currentLang === 'vi' ? 'Chưa có ai tham gia!' : 'No one has played yet!'}</td></tr>`;
            }
        }
        
        // ... (các hàm khác như submitUserQuestion giữ nguyên logic, chỉ thêm đa ngôn ngữ cho alert)
        
        window.loadNextQuestion = function() {
            if(availableQuestions.length === 0) { 
                endQuizAndSubmitScore();
                return;
            }

            document.getElementById('next-btn').style.display = 'none';
            
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const qData = availableQuestions[randomIndex];
            
            document.getElementById('q-category').innerText = qData.cat || (currentLang === 'vi' ? 'Chung' : 'General');
            document.getElementById('q-text').innerText = qData.q;
            
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            
            qData.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = ans;
                btn.onclick = () => checkAnswer(btn, qData, idx); 
                optDiv.appendChild(btn);
            });
        }
        
        window.submitUserQuestion = async function() {
            // ... (Phần lấy dữ liệu input giữ nguyên)
            const qText = document.getElementById('q-text-input').value.trim();
            const ans0 = document.getElementById('q-ans-0').value.trim();
            const ans1 = document.getElementById('q-ans-1').value.trim();
            const ans2 = document.getElementById('q-ans-2').value.trim();
            const ans3 = document.getElementById('q-ans-3').value.trim();
            const correctIdx = parseInt(document.getElementById('q-correct-select').value);
            const category = document.getElementById('q-cat-input').value.trim() || (currentLang === 'vi' ? 'Cộng đồng' : 'Community');

            if (!qText || !ans0 || !ans1 || !ans2 || !ans3 || correctIdx === -1) {
                return alert(currentLang === 'vi' ? "Vui lòng điền đầy đủ nội dung câu hỏi, 4 đáp án và chọn đáp án đúng." : "Please fill in all question content, 4 answers, and select the correct answer.");
            }

            try {
                await addDoc(submittedQuestionsRef, {
                    q: qText, a: [ans0, ans1, ans2, ans3], c: correctIdx, cat: category,
                    submittedBy: currentUserName || translations[currentLang]['anonymous'],
                    createdAt: serverTimestamp(), status: 'Chưa duyệt' 
                });

                alert(currentLang === 'vi' ? "Gửi câu hỏi thành công! Cảm ơn bạn đã đóng góp." : "Question submitted successfully! Thank you for contributing.");
                // Reset form
                document.getElementById('q-text-input').value = '';
                document.getElementById('q-ans-0').value = '';
                document.getElementById('q-ans-1').value = '';
                document.getElementById('q-ans-2').value = '';
                document.getElementById('q-ans-3').value = '';
                document.getElementById('q-correct-select').value = '-1';
                document.getElementById('q-cat-input').value = '';

            } catch (error) {
                console.error("Lỗi gửi câu hỏi:", error);
                alert((currentLang === 'vi' ? "Lỗi gửi câu hỏi: " : "Error submitting question: ") + error.message);
            }
        }
        
    </script>
</body>
</html>