<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>12B2 - C·ªông ƒê·ªìng & Tu·ªïi Th∆°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS CHUNG V√Ä HI·ªÜU ·ª®NG M·ªöI */
        :root { 
            --primary-gradient: linear-gradient(135deg, #6dd5ed, #2193b0); /* Xanh bi·ªÉn t∆∞∆°i s√°ng */
            --secondary-gradient: linear-gradient(135deg, #f7b733, #fc4a1a); /* Cam-V√†ng nƒÉng ƒë·ªông */
            --button-hover: linear-gradient(135deg, #4facfe, #00f2fe); /* Xanh nh·∫°t cho hover */
            --bg-color: #f0f2f5; /* N·ªÅn x√°m nh·∫°t */
            --card-bg: #ffffff; 
            --text-color: #333; 
            --light-text-color: #666;
            --border-color: #e0e0e0;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); 
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.12);
            --radius-large: 20px;
            --radius-medium: 12px;
            --radius-small: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; }
        body { 
            background: var(--bg-color); 
            padding-bottom: 70px; 
            color: var(--text-color); 
            transition: background 0.4s ease-in-out;
            min-height: 100vh;
        }
        .navbar { 
            background: var(--primary-gradient); 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            color: white; 
            font-weight: 700; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow-medium); 
            border-bottom-left-radius: var(--radius-large);
            border-bottom-right-radius: var(--radius-large);
        }
        .navbar a { 
            color: white; 
            text-decoration: none; 
            margin-left: 15px; 
            font-size: 0.95rem; 
            transition: opacity 0.3s ease-in-out; 
        }
        .navbar a:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* LANGUAGE SWITCH */
        #lang-switch { 
            background: rgba(255, 255, 255, 0.3); 
            border-radius: var(--radius-large); 
            padding: 5px 12px; 
            cursor: pointer; 
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.3s ease-in-out;
            margin-left: 15px;
        }
        #lang-switch:hover { background: rgba(255, 255, 255, 0.45); }
        
        .container { max-width: 650px; margin: 20px auto; padding: 0 15px; }
        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: var(--radius-large); 
            margin-bottom: 25px; 
            box-shadow: var(--shadow-light); 
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-medium); 
        }
        
        /* TAB NAVIGATION */
        .tab-nav {
            display: flex;
            justify-content: space-around;
            background: var(--card-bg);
            padding: 8px;
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .tab-btn {
            background: none;
            border: none;
            color: var(--light-text-color);
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: var(--radius-medium);
            transition: color 0.3s ease-in-out, background 0.3s ease-in-out, transform 0.2s ease-in-out;
            flex-grow: 1;
            margin: 0 5px;
        }
        .tab-btn:hover:not(.active) {
            color: var(--text-color);
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        .tab-btn.active {
            color: white;
            background: var(--primary-gradient);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            font-weight: 700;
        }
        .tab-content { animation: fadeIn 0.6s ease-out; }
        
        /* HEADINGS */
        h3 { 
            color: #34495e; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            font-weight: 700;
        }
        h3 i { 
            margin-right: 10px; 
            color: #4CAF50; 
            font-size: 1.2em;
        }
        h4 { color: #555; margin-bottom: 15px; font-weight: 600; }

        /* INPUTS & BUTTONS */
        input[type="text"], textarea, select {
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-medium); 
            outline: none; 
            font-size: 1rem; 
            margin-bottom: 15px; 
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            color: var(--text-color);
        }
        input[type="text"]:focus, textarea:focus, select:focus { 
            border-color: #6dd5ed; 
            box-shadow: 0 0 0 3px rgba(109, 213, 237, 0.2);
        }
        textarea { resize: vertical; min-height: 80px; }

        .btn-send, .next-btn, #name-input-section button, #tictactoe-reset { 
            background: var(--primary-gradient); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: var(--radius-large); 
            cursor: pointer; 
            font-weight: 700;
            font-size: 1.05rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-send:hover, .next-btn:hover, #name-input-section button:hover, #tictactoe-reset:hover { 
            background: var(--button-hover); 
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .next-btn { background: var(--secondary-gradient); }
        .next-btn:hover { background: linear-gradient(135deg, #fc4a1a, #f7b733); }

        /* CHAT/MESSAGE STYLES */
        .post-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-size: 0.9rem; 
            color: var(--light-text-color); 
            align-items: center;
        }
        .post-author { 
            font-weight: 700; 
            color: #4CAF50; 
            font-size: 1.05rem; 
            display: flex;
            align-items: center;
        }
        .post-author i { margin-right: 5px; font-size: 0.9em; }
        
        /* QUIZ STYLES */
        .quiz-stat { 
            font-size: 1rem; 
            color: var(--light-text-color); 
            margin-bottom: 15px; 
            line-height: 1.6;
        }
        .quiz-stat strong { color: var(--text-color); }
        .question-box { 
            font-size: 1.35rem; 
            font-weight: 700; 
            margin: 25px 0; 
            min-height: 70px; 
            color: var(--text-color);
            animation: fadeIn 0.7s ease-out; 
            line-height: 1.5;
        }
        #q-category { 
            display: inline-block; 
            background: #e9ecef; 
            padding: 6px 15px; 
            border-radius: var(--radius-large); 
            font-size: 0.85rem; 
            margin-bottom: 15px; 
            color: #555;
            font-weight: 600;
        }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .opt-btn { 
            padding: 15px 20px; 
            border: 1px solid var(--border-color); 
            background: #fdfdfd; 
            border-radius: var(--radius-medium); 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s ease-in-out; 
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            line-height: 1.4;
        }
        .opt-btn:not(:disabled):hover { 
            background: #e8f7ff; 
            border-color: #6dd5ed; 
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .opt-btn.correct { 
            background: #d4edda; 
            border-color: #28a745; 
            color: #155724; 
            font-weight: 700; 
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }
        .opt-btn.wrong { 
            background: #f8d7da; 
            border-color: #dc3545; 
            color: #721c24; 
            font-weight: 700; 
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }
        
        /* QUIZ COMPLETE */
        #quiz-complete h3 { color: #4CAF50; margin-top: 10px; }
        #quiz-complete .fa-trophy { color: #FFD700; }
        #quiz-complete button { 
            background: #f0f0f0; 
            color: var(--text-color); 
            border: 1px solid #ddd;
            font-weight: 600;
        }
        #quiz-complete button:hover { 
            background: #e0e0e0; 
            transform: translateY(-2px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* RANKING */
        .rank-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        .rank-table th, .rank-table td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            text-align: left; 
        }
        .rank-table th { 
            background: #f8f9fa; 
            color: #2193b0; 
            font-weight: 700; 
            text-transform: uppercase;
        }
        .rank-table tr:first-child th:first-child { border-top-left-radius: var(--radius-medium); }
        .rank-table tr:first-child th:last-child { border-top-right-radius: var(--radius-medium); }
        .rank-table tr:last-child td:first-child { border-bottom-left-radius: var(--radius-medium); }
        .rank-table tr:last-child td:last-child { border-bottom-right-radius: var(--radius-medium); }


        .rank-table tr:nth-child(even) { background-color: #fcfcfc; }
        .rank-table tr:hover { background-color: #f5f5f5; }

        .rank-table tr:nth-child(1) td { font-weight: 700; color: #FFD700; font-size: 1.15em; } /* V√†ng */
        .rank-table tr:nth-child(2) td { font-weight: 600; color: #C0C0C0; font-size: 1.1em; } /* B·∫°c */
        .rank-table tr:nth-child(3) td { font-weight: 600; color: #CD7F32; font-size: 1.05em; } /* ƒê·ªìng */
        
        /* TIC-TAC-TOE (C·ªú CARO) STYLES */
        .tictactoe-wrapper {
            text-align: center;
        }
        #tictactoe-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 300px; /* K√≠ch th∆∞·ªõc t·ªëi ∆∞u cho mobile */
            height: 300px;
            margin: 20px auto;
            border: 5px solid #333;
            border-radius: var(--radius-medium);
            background: #fff;
        }
        .cell {
            border: 3px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            cursor: pointer;
            font-weight: 700;
            color: #333;
            transition: background 0.2s;
        }
        .cell:hover:not(.x):not(.o) {
            background: #f0f8ff; 
        }
        /* Lo·∫°i b·ªè border kh√¥ng c·∫ßn thi·∫øt */
        .cell:nth-child(3n) { border-right: none; }
        .cell:nth-child(3n+1) { border-left: none; }
        .cell:nth-child(-n+3) { border-top: none; }
        .cell:nth-child(n+7) { border-bottom: none; }

        .cell.x { color: #2193b0; } 
        .cell.o { color: #fc4a1a; } 

        #tictactoe-status {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        #tictactoe-reset {
            background: #4CAF50; 
            margin-top: 15px;
        }
        @media (max-width: 400px) {
            #tictactoe-board {
                width: 270px;
                height: 270px;
            }
            .cell {
                font-size: 3rem;
            }
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        hr { border-top: 1px dashed var(--border-color); margin: 30px 0; }
    </style>
</head>
<body onload="initApp()">

    <div class="navbar">
        <div>12B2 <span data-i18n="community">C·ªông ƒê·ªìng</span></div>
        <div style="display: flex; align-items: center;">
            <a href="https://www.tiktok.com/@12b2thptcamau?is_from_webapp=1&sender_device=pc" target="_blank" style="font-size: 1.2rem;" title="TikTok c·ªßa l·ªõp"><i class="fab fa-tiktok"></i></a>
            <div id="lang-switch" onclick="toggleLanguage()">VI / EN</div>
        </div>
    </div>

    <div class="container">

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="social" onclick="showTab('social')" data-i18n="social_tab">Social & Quiz</button>
            <button class="tab-btn" data-tab="games" onclick="showTab('games')" data-i18n="game_tab">Games (Tu·ªïi Th∆°)</button>
        </div>

        <div id="social" class="tab-content">

            <h3><i class="fas fa-comments"></i> <span data-i18n="chat_title">G√≥c Chat ·∫®n Danh</span></h3>
            <div class="create-message card">
                <textarea id="message-text" rows="3" data-i18n-placeholder="chat_placeholder" placeholder="G·ª≠i tin nh·∫Øn ·∫©n danh cho c·∫£ l·ªõp..."></textarea>
                <div class="msg-actions">
                    <button id="btn-send-msg" class="btn-send" onclick="sendMessage()" data-i18n="send_msg">G·ª≠i tin nh·∫Øn</button>
                </div>
            </div>
            <div id="message-list">
                <div style="text-align: center; color: var(--light-text-color); margin-top: 20px;" data-i18n="loading_msg">ƒêang t·∫£i tin nh·∫Øn...</div>
            </div>

            <hr>

            <h3><i class="fas fa-brain"></i> <span data-i18n="quiz_title">Th·ª≠ Th√°ch ƒê·ªë Vui</span></h3>
            
            <div id="name-input-section" class="card">
                <h4 data-i18n="name_prompt">B·∫Øt ƒë·∫ßu Quiz! Vui l√≤ng nh·∫≠p t√™n (ƒë·ªÉ l√™n BXH):</h4>
                <input type="text" id="user-name-input" data-i18n-placeholder="name_placeholder" placeholder="T√™n c·ªßa b·∫°n (v√≠ d·ª•: Nam K·∫ø To√°n)">
                <button onclick="saveUserName()" data-i18n="start_quiz">B·∫Øt ƒë·∫ßu Quiz</button>
            </div>

            <div id="quiz-section" style="display: none;">
                <div class="quiz-card card">
                    <div class="quiz-stat"><span data-i18n="welcome">Ch√†o m·ª´ng</span>, <span id="current-user-display" style="color: #4CAF50; font-weight: bold;"></span>!</div>
                    <div class="quiz-stat"><span data-i18n="completed">ƒê√£ ho√†n th√†nh</span>: <span id="done-count">0</span> <span data-i18n="q_count">c√¢u</span> | <span data-i18n="score">ƒêi·ªÉm hi·ªán t·∫°i</span>: <span id="current-score">0</span></div>
                    
                    <div id="quiz-content">
                        <div id="q-category" data-i18n="topic">Ch·ªß ƒë·ªÅ</div>
                        <div id="q-text" class="question-box"></div>
                        <div id="options" class="options-grid"></div>
                        <button id="next-btn" class="next-btn" onclick="loadNextQuestion()" data-i18n="next_q">C√¢u ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                    </div>

                    <div id="quiz-complete" style="display: none; padding: 30px; text-align: center;">
                        <i class="fas fa-trophy" style="font-size: 3.5rem; color: gold; margin-bottom: 20px;"></i>
                        <h3 style="justify-content: center;"><span data-i18n="quiz_done_h3">Ho√†n th√†nh!</span></h3>
                        <p style="margin-bottom: 20px;"><span data-i18n="final_score_p">T·ªïng ƒëi·ªÉm c·ªßa b·∫°n</span>: <strong id="final-score-display"></strong>. <span data-i18n="sending_rank">ƒêang g·ª≠i k·∫øt qu·∫£ l√™n BXH...</span></p>
                        <button onclick="resetQuiz()" data-i18n="play_again" class="btn-send" style="background: #e0e0e0; color: var(--text-color); width: auto;">L√†m l·∫°i</button>
                    </div>
                </div>
            </div>

            <hr>

            <h3><i class="fas fa-plus-circle"></i> <span data-i18n="create_q_title">T·∫°o C√¢u H·ªèi M·ªõi</span></h3>
            <div id="create-question-section" class="card">
                <h4 data-i18n="contribute_q">ƒê√≥ng g√≥p Quiz (C√¢u h·ªèi ƒë∆∞·ª£c d√πng ngay):</h4>
                <input type="text" id="q-text-input" data-i18n-placeholder="q_content_ph" placeholder="N·ªôi dung C√¢u h·ªèi">
                <input type="text" id="q-ans-0" data-i18n-placeholder="ans_a_ph" placeholder="ƒê√°p √°n A">
                <input type="text" id="q-ans-1" data-i18n-placeholder="ans_b_ph" placeholder="ƒê√°p √°n B">
                <input type="text" id="q-ans-2" data-i18n-placeholder="ans_c_ph" placeholder="ƒê√°p √°n C">
                <input type="text" id="q-ans-3" data-i18n-placeholder="ans_d_ph" placeholder="ƒê√°p √°n D">
                <select id="q-correct-select">
                    <option value="-1" data-i18n="select_correct_ans">Ch·ªçn ƒê√°p √°n ƒê√∫ng</option>
                    <option value="0" data-i18n="ans_a_correct">ƒê√°p √°n A l√† ƒë√∫ng</option>
                    <option value="1" data-i18n="ans_b_correct">ƒê√°p √°n B l√† ƒë√∫ng</option>
                    <option value="2" data-i18n="ans_c_correct">ƒê√°p √°n C l√† ƒë√∫ng</option>
                    <option value="3" data-i18n="ans_d_correct">ƒê√°p √°n D l√† ƒë√∫ng</option>
                </select>
                <input type="text" id="q-cat-input" data-i18n-placeholder="category_ph" placeholder="Ch·ªß ƒë·ªÅ (v√≠ d·ª•: To√°n, L√Ω)">
                <button class="btn-send" style="width: 100%;" onclick="submitUserQuestion()" data-i18n="submit_q">G·ª≠i ƒë√≥ng g√≥p</button>
            </div>
            
            <hr>

            <h3><i class="fas fa-trophy"></i> <span data-i18n="leaderboard_title">B·∫£ng X·∫øp H·∫°ng (Top 10)</span></h3>
            <div id="leaderboard-section" class="card">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th data-i18n="rank">H·∫°ng</th>
                            <th data-i18n="name">T√™n</th>
                            <th data-i18n="score">ƒêi·ªÉm</th>
                            <th data-i18n="date">Ng√†y ch∆°i</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" style="text-align: center;" data-i18n="loading_rank">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</td></tr>
                    </tbody>
                </table>
            </div>

        </div> 

        <div id="games" class="tab-content" style="display: none;">
            <h3 style="margin-bottom: 25px;"><i class="fas fa-gamepad"></i> <span data-i18n="game_h3">Khu V·ª±c Tr√≤ Ch∆°i Tu·ªïi Th∆° (C·ªù Caro)</span></h3>
            
            <div class="tictactoe-wrapper card">
                <h4 data-i18n="tictactoe_title">Ch∆°i C·ªù Caro (Tic-Tac-Toe)</h4>
                <div id="tictactoe-status" data-i18n="tictactoe_status_x">L∆∞·ª£t c·ªßa X</div>
                <div id="tictactoe-board">
                    <div class="cell" data-index="0"></div>
                    <div class="cell" data-index="1"></div>
                    <div class="cell" data-index="2"></div>
                    <div class="cell" data-index="3"></div>
                    <div class="cell" data-index="4"></div>
                    <div class="cell" data-index="5"></div>
                    <div class="cell" data-index="6"></div>
                    <div class="cell" data-index="7"></div>
                    <div class="cell" data-index="8"></div>
                </div>
                <button id="tictactoe-reset" data-i18n="tictactoe_reset" onclick="resetGame()">Ch∆°i l·∫°i</button>
            </div>
            
        </div> 
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- D·ªÆ LI·ªÜU ƒêA NG√îN NG·ªÆ ---
        const translations = {
            'vi': {
                'community': 'C·ªông ƒê·ªìng',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Tu·ªïi Th∆°)',
                'chat_title': 'G√≥c Chat ·∫®n Danh',
                'chat_placeholder': 'G·ª≠i tin nh·∫Øn ·∫©n danh cho c·∫£ l·ªõp...',
                'send_msg': 'G·ª≠i tin nh·∫Øn',
                'loading_msg': 'ƒêang t·∫£i tin nh·∫Øn...',
                'quiz_title': 'Th·ª≠ Th√°ch ƒê·ªë Vui',
                'name_prompt': 'B·∫Øt ƒë·∫ßu Quiz! Vui l√≤ng nh·∫≠p t√™n (ƒë·ªÉ l√™n BXH):',
                'name_placeholder': 'T√™n c·ªßa b·∫°n (v√≠ d·ª•: Nam K·∫ø To√°n)',
                'start_quiz': 'B·∫Øt ƒë·∫ßu Quiz',
                'welcome': 'Ch√†o m·ª´ng',
                'completed': 'ƒê√£ ho√†n th√†nh',
                'q_count': 'c√¢u',
                'score': 'ƒêi·ªÉm hi·ªán t·∫°i',
                'topic': 'Ch·ªß ƒë·ªÅ',
                'next_q': 'C√¢u ti·∫øp theo',
                'quiz_done_h3': 'Ho√†n th√†nh!',
                'final_score_p': 'T·ªïng ƒëi·ªÉm c·ªßa b·∫°n',
                'sending_rank': 'ƒêang g·ª≠i k·∫øt qu·∫£ l√™n BXH...',
                'play_again': 'L√†m l·∫°i',
                'create_q_title': 'T·∫°o C√¢u H·ªèi M·ªõi',
                'contribute_q': 'ƒê√≥ng g√≥p Quiz (C√¢u h·ªèi ƒë∆∞·ª£c d√πng ngay):',
                'q_content_ph': 'N·ªôi dung C√¢u h·ªèi',
                'ans_a_ph': 'ƒê√°p √°n A', 'ans_b_ph': 'ƒê√°p √°n B', 'ans_c_ph': 'ƒê√°p √°n C', 'ans_d_ph': 'ƒê√°p √°n D',
                'select_correct_ans': 'Ch·ªçn ƒê√°p √°n ƒê√∫ng',
                'ans_a_correct': 'ƒê√°p √°n A l√† ƒë√∫ng', 'ans_b_correct': 'ƒê√°p √°n B l√† ƒë√∫ng', 'ans_c_correct': 'ƒê√°p √°n C l√† ƒë√∫ng', 'ans_d_correct': 'ƒê√°p √°n D l√† ƒë√∫ng',
                'category_ph': 'Ch·ªß ƒë·ªÅ (v√≠ d·ª•: To√°n, L√Ω)',
                'submit_q': 'G·ª≠i ƒë√≥ng g√≥p',
                'leaderboard_title': 'B·∫£ng X·∫øp H·∫°ng (Top 10)',
                'rank': 'H·∫°ng', 'name': 'T√™n', 'date': 'Ng√†y ch∆°i',
                'loading_rank': 'ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...',
                'game_h3': 'Khu V·ª±c Tr√≤ Ch∆°i Tu·ªïi Th∆° (C·ªù Caro)',
                'tictactoe_title': 'Ch∆°i C·ªù Caro (Tic-Tac-Toe)',
                'tictactoe_status_x': 'L∆∞·ª£t c·ªßa X',
                'tictactoe_status_o': 'L∆∞·ª£t c·ªßa O',
                'tictactoe_win_x': 'X th·∫Øng! ü•≥',
                'tictactoe_win_o': 'O th·∫Øng! ü•≥',
                'tictactoe_draw': 'H√≤a! ü§ù',
                'tictactoe_reset': 'Ch∆°i l·∫°i',
                'anonymous': '·∫®n danh'
            },
            'en': {
                'community': 'Community',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Childhood)',
                'chat_title': 'Anonymous Chat Corner',
                'chat_placeholder': 'Send an anonymous message to the class...',
                'send_msg': 'Send Message',
                'loading_msg': 'Loading messages...',
                'quiz_title': 'Quiz Challenge',
                'name_prompt': 'Start Quiz! Please enter your name (for Leaderboard):',
                'name_placeholder': 'Your name (e.g., John Doe)',
                'start_quiz': 'Start Quiz',
                'welcome': 'Welcome',
                'completed': 'Completed',
                'q_count': 'questions',
                'score': 'Current Score',
                'topic': 'Topic',
                'next_q': 'Next Question',
                'quiz_done_h3': 'Finished!',
                'final_score_p': 'Your total score',
                'sending_rank': 'Submitting score to Leaderboard...',
                'play_again': 'Play Again',
                'create_q_title': 'Create New Question',
                'contribute_q': 'Contribute Quiz (Question is used immediately):',
                'q_content_ph': 'Question Content',
                'ans_a_ph': 'Answer A', 'ans_b_ph': 'Answer B', 'ans_c_ph': 'Answer C', 'ans_d_ph': 'Answer D',
                'select_correct_ans': 'Select Correct Answer',
                'ans_a_correct': 'Answer A is correct', 'ans_b_correct': 'Answer B is correct', 'ans_c_correct': 'Answer C is correct', 'ans_d_correct': 'Answer D is correct',
                'category_ph': 'Category (e.g., Math, Physics)',
                'submit_q': 'Submit Contribution',
                'leaderboard_title': 'Leaderboard (Top 10)',
                'rank': 'Rank', 'name': 'Name', 'date': 'Play Date',
                'loading_rank': 'Loading leaderboard...',
                'game_h3': 'Childhood Games Zone (Tic-Tac-Toe)',
                'tictactoe_title': 'Play Tic-Tac-Toe',
                'tictactoe_status_x': 'X\'s turn',
                'tictactoe_status_o': 'O\'s turn',
                'tictactoe_win_x': 'X wins! ü•≥',
                'tictactoe_win_o': 'O wins! ü•≥',
                'tictactoe_draw': 'Draw! ü§ù',
                'tictactoe_reset': 'Play Again',
                'anonymous': 'Anonymous'
            }
        };

        let currentLang = localStorage.getItem('appLang') || 'vi';

        window.toggleLanguage = function() {
            currentLang = currentLang === 'vi' ? 'en' : 'vi';
            localStorage.setItem('appLang', currentLang);
            applyLanguage(currentLang);
            updateGameStatusDisplay(); 
        }

        function applyLanguage(lang) {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = translations[lang][key];
            });

            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[lang][key];
            });
            
            loadLeaderboard(); 
            onSnapshot(query(chatRef, orderBy("createdAt", "desc"), limit(10)), updateChatList);
            updateGameStatusDisplay(); 
        }
        
        // --- LOGIC TAB CON ---
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'games') {
                if (!window.ticTacToeInitialized) {
                    initTicTacToe();
                    window.ticTacToeInitialized = true;
                }
            }
        }

        // ‚ö†Ô∏è THAY TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY (VUI L√íNG D√ôNG TH√îNG TIN C·ª¶A B·∫†N)
        const firebaseConfig = {
            apiKey: "AIzaSyBSqEO-mi650wMN2gwVac3nwLFtg4TTX80", // üëà THAY TH·∫æ KEY C·ª¶A B·∫†N
            authDomain: "b2-6431c.firebaseapp.com",
            projectId: "b2-6431c",
            storageBucket: "b2-6431c.appspot.com",
            messagingSenderId: "164059778488",
            appId: "1:164059778488:web:9eca97e23ab644df48534d",
            measurementId: "G-19QWD4RCYC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // C√ÅC COLLECTIONS S·ª¨ D·ª§NG
        const chatRef = collection(db, "anonymous_messages");
        const quizRef = collection(db, "quiz_questions"); 
        const leaderboardRef = collection(db, "quiz_leaderboard"); 

        // BI·∫æN TO√ÄN C·ª§C QUIZ
        let availableQuestions = [];
        let fullQuestionBank = [];
        let currentScore = 0;
        let questionsAttempted = 0;
        let currentUserName = localStorage.getItem('userName12B2') || null;

        // --- H√ÄM KH·ªûI T·∫†O CHUNG (CH·∫†Y KHI T·∫¢I TRANG) ---
        window.initApp = function() {
            applyLanguage(currentLang);
            loadLeaderboard();
            if (currentUserName) {
                document.getElementById('current-user-display').innerText = currentUserName;
                document.getElementById('name-input-section').style.display = 'none';
                document.getElementById('quiz-section').style.display = 'block';
                initQuiz();
            } else {
                document.getElementById('name-input-section').style.display = 'block';
                document.getElementById('quiz-section').style.display = 'none';
            }
            initTicTacToe(); 
        }

        // --- LOGIC TIC-TAC-TOE (C·ªú CARO) ---
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameActive = true;

        const cells = document.querySelectorAll('.cell');
        const statusDisplay = document.getElementById('tictactoe-status');
        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]           
        ];

        function updateGameStatusDisplay() {
            if (!gameActive) {
                return; 
            }
            const key = currentPlayer === 'X' ? 'tictactoe_status_x' : 'tictactoe_status_o';
            statusDisplay.textContent = translations[currentLang][key];
        }
        
        function handleResultValidation() {
            let roundWon = false;
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = board[winCondition[0]];
                let b = board[winCondition[1]];
                let c = board[winCondition[2]];

                if (a === '' || b === '' || c === '') continue;

                if (a === b && b === c) {
                    roundWon = true;
                    break;
                }
            }

            if (roundWon) {
                statusDisplay.textContent = translations[currentLang][currentPlayer === 'X' ? 'tictactoe_win_x' : 'tictactoe_win_o'];
                gameActive = false;
                return;
            }

            let roundDraw = !board.includes('');
            if (roundDraw) {
                statusDisplay.textContent = translations[currentLang]['tictactoe_draw'];
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            updateGameStatusDisplay();
        }

        function handleCellClick(clickedCellEvent) {
            const clickedCell = clickedCellEvent.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-index'));

            if (board[clickedCellIndex] !== '' || !gameActive) return;

            board[clickedCellIndex] = currentPlayer;
            clickedCell.textContent = currentPlayer;
            clickedCell.classList.add(currentPlayer.toLowerCase());

            handleResultValidation();
        }
        
        window.resetGame = function() {
            gameActive = true;
            currentPlayer = 'X';
            board = ['', '', '', '', '', '', '', '', ''];
            updateGameStatusDisplay();
            cells.forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('x', 'o');
            });
        }

        function initTicTacToe() {
            cells.forEach(cell => {
                cell.removeEventListener('click', handleCellClick); 
                cell.addEventListener('click', handleCellClick);
            });
            resetGame(); 
        }

        // --- H√ÄM X·ª¨ L√ù T√äN NG∆Ø·ªúI D√ôNG ---
        window.saveUserName = function() {
            const nameInput = document.getElementById('user-name-input').value.trim();
            if (nameInput.length < 2 || nameInput.length > 20) {
                alert(currentLang === 'vi' ? "T√™n ph·∫£i t·ª´ 2 ƒë·∫øn 20 k√Ω t·ª±!" : "Name must be between 2 and 20 characters!");
                return;
            }
            currentUserName = nameInput;
            localStorage.setItem('userName12B2', currentUserName);
            document.getElementById('current-user-display').innerText = currentUserName;
            document.getElementById('name-input-section').style.display = 'none';
            document.getElementById('quiz-section').style.display = 'block';
            initQuiz();
        }

        // --- PH·∫¶N 1: G·ª¨I V√Ä HI·ªÇN TH·ªä TIN NH·∫ÆN ·∫®N DANH ---
        window.sendMessage = async function() {
            const messageText = document.getElementById('message-text').value;
            const btn = document.getElementById('btn-send-msg');
            if (!messageText.trim()) return;

            btn.disabled = true;
            btn.innerText = currentLang === 'vi' ? "ƒêang g·ª≠i..." : "Sending...";

            try {
                await addDoc(chatRef, {
                    text: messageText,
                    createdAt: serverTimestamp(),
                    author: translations[currentLang]['anonymous'] 
                });
                document.getElementById('message-text').value = '';
            } catch (error) {
                console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
                alert((currentLang === 'vi' ? "L·ªói g·ª≠i tin nh·∫Øn: " : "Error sending message: ") + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = translations[currentLang]['send_msg'];
            }
        }
        
        const updateChatList = (snapshot) => {
            const list = document.getElementById("message-list");
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const msg = doc.data();
                const date = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : (currentLang === 'vi' ? 'V·ª´a xong' : 'Just now');
                const authorDisplay = msg.author || translations[currentLang]['anonymous'];
                list.innerHTML += `<div class="post card"><div class="post-header"><span class="post-author"><i class="fas fa-user-secret"></i> ${authorDisplay}</span><span>${date}</span></div><div style="font-size: 1rem; line-height: 1.5;">${msg.text}</div></div>`;
            });
        };

        onSnapshot(query(chatRef, orderBy("createdAt", "desc"), limit(10)), updateChatList);

        // --- PH·∫¶N 2: QUIZ V·ªöI ƒêI·ªÇM S·ªê & T√äN (CH·ªà D√ôNG FIRESTORE) ---
        
        window.initQuiz = async function() {
            currentScore = 0;
            questionsAttempted = 0;
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('quiz-content').style.display = 'block';
            document.getElementById('quiz-complete').style.display = 'none';
            document.getElementById('q-text').innerText = currentLang === 'vi' ? "ƒêang t·∫£i c√¢u h·ªèi t·ª´ c·ªông ƒë·ªìng..." : "Loading questions from community..."; 
            
            if (fullQuestionBank.length === 0) {
                try {
                    const querySnapshot = await getDocs(quizRef);
                    querySnapshot.forEach((doc) => { fullQuestionBank.push({ id: doc.id, ...doc.data() }); });
                    if (fullQuestionBank.length === 0) {
                        document.getElementById('q-text').innerText = currentLang === 'vi' ? "Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c Admin duy·ªát. Vui l√≤ng ƒë√≥ng g√≥p!" : "No questions have been approved by Admin. Please contribute!";
                        document.getElementById('options').innerHTML = '';
                        return;
                    }
                } catch (e) {
                    document.getElementById('q-text').innerText = currentLang === 'vi' ? "L·ªói k·∫øt n·ªëi ho·∫∑c ch∆∞a c√≥ c√¢u h·ªèi. Vui l√≤ng ki·ªÉm tra Rules Firestore." : "Connection error or no questions. Check Firestore Rules.";
                    return;
                }
            }

            const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]').map(item => item.id) || [];
            availableQuestions = fullQuestionBank.filter(q => !doneIds.includes(q.id));

            if(availableQuestions.length === 0) {
                localStorage.removeItem('quiz_done_ids');
                availableQuestions = fullQuestionBank;
            } 
            loadNextQuestion();
        }

        window.loadNextQuestion = function() {
            if(availableQuestions.length === 0) { 
                endQuizAndSubmitScore();
                return;
            }

            document.getElementById('next-btn').style.display = 'none';
            
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const qData = availableQuestions[randomIndex];
            
            document.getElementById('q-category').innerText = qData.cat || (currentLang === 'vi' ? 'Chung' : 'General');
            document.getElementById('q-text').innerText = qData.q;
            
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            
            qData.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = ans;
                btn.onclick = () => checkAnswer(btn, qData, idx); 
                optDiv.appendChild(btn);
            });
        }

        window.checkAnswer = function(btn, qData, selectedIdx) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true); 

            questionsAttempted++;

            if(selectedIdx === qData.c) {
                btn.classList.add('correct');
                currentScore += 10; 
                
                const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]') || [];
                if(!doneIds.some(item => item.id === qData.id)) {
                    doneIds.push({ id: qData.id, date: new Date().getTime() });
                    localStorage.setItem('quiz_done_ids', JSON.stringify(doneIds));
                }

            } else {
                btn.classList.add('wrong');
                allBtns[qData.c].classList.add('correct'); 
            }
            
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('next-btn').style.display = 'inline-block';
            
            availableQuestions = availableQuestions.filter(q => q.id !== qData.id);
        }

        function endQuizAndSubmitScore() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('quiz-complete').style.display = 'block';
            document.getElementById('final-score-display').innerText = currentScore;
            
            saveScoreToLeaderboard(currentScore, questionsAttempted);
        }
        
        async function saveScoreToLeaderboard(score, attempts) {
            if (!currentUserName || score === 0) return; 

            try {
                await addDoc(leaderboardRef, {
                    name: currentUserName,
                    score: score,
                    attempts: attempts,
                    createdAt: serverTimestamp()
                });
                loadLeaderboard(); 
            } catch (error) {
                console.error("L·ªói l∆∞u BXH:", error);
            }
        }

        window.loadLeaderboard = async function() {
            const q = query(leaderboardRef, orderBy("score", "desc"), limit(10)); 
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : 'N/A';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${rank++}</td>
                        <td>${data.name}</td>
                        <td>${data.score}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });

            if (snapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${currentLang === 'vi' ? 'Ch∆∞a c√≥ ai tham gia!' : 'No one has played yet!'}</td></tr>`;
            }
        }

        window.resetQuiz = function() {
            questionsAttempted = 0;
            currentScore = 0;
            localStorage.removeItem('quiz_done_ids'); 
            initQuiz();
        }

        // --- PH·∫¶N 3: T·∫†O C√ÇU H·ªéI M·ªöI (T·ª∞ ƒê·ªòNG ƒê∆ØA V√ÄO QUIZ) ---
        window.submitUserQuestion = async function() {
            const qText = document.getElementById('q-text-input').value.trim();
            const ans0 = document.getElementById('q-ans-0').value.trim();
            const ans1 = document.getElementById('q-ans-1').value.trim();
            const ans2 = document.getElementById('q-ans-2').value.trim();
            const ans3 = document.getElementById('q-ans-3').value.trim();
            const correctIdx = parseInt(document.getElementById('q-correct-select').value);
            const category = document.getElementById('q-cat-input').value.trim() || (currentLang === 'vi' ? 'C·ªông ƒë·ªìng' : 'Community');
            const submitButton = document.querySelector('#create-question-section button.btn-send');

            if (!qText || !ans0 || !ans1 || !ans2 || !ans3 || correctIdx === -1) {
                return alert(currentLang === 'vi' ? "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung c√¢u h·ªèi, 4 ƒë√°p √°n v√† ch·ªçn ƒë√°p √°n ƒë√∫ng." : "Please fill in all question content, 4 answers, and select the correct answer.");
            }
            
            submitButton.disabled = true;
            submitButton.textContent = currentLang === 'vi' ? "ƒêang x·ª≠ l√Ω..." : "Processing...";


            try {
                // L∆ØU TH·∫≤NG V√ÄO collection quiz_questions
                await addDoc(quizRef, { 
                    q: qText, 
                    a: [ans0, ans1, ans2, ans3], 
                    c: correctIdx, 
                    cat: category,
                    submittedBy: currentUserName || translations[currentLang]['anonymous'],
                    createdAt: serverTimestamp(),
                });

                alert(currentLang === 'vi' ? "C√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c th√™m v√†o Quiz ngay l·∫≠p t·ª©c! C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p." : "Question has been added to the Quiz immediately! Thank you for contributing.");
                
                // C·∫≠p nh·∫≠t l·∫°i b·ªô c√¢u h·ªèi trong b·ªô nh·ªõ ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ ch∆°i ngay
                fullQuestionBank = []; 
                await initQuiz(); 

                // Reset form
                document.getElementById('q-text-input').value = '';
                document.getElementById('q-ans-0').value = '';
                document.getElementById('q-ans-1').value = '';
                document.getElementById('q-ans-2').value = '';
                document.getElementById('q-ans-3').value = '';
                document.getElementById('q-correct-select').value = '-1';
                document.getElementById('q-cat-input').value = '';

            } catch (error) {
                console.error("L·ªói g·ª≠i c√¢u h·ªèi:", error);
                alert((currentLang === 'vi' ? "L·ªói g·ª≠i c√¢u h·ªèi: " : "Error submitting question: ") + error.message);
            } finally {
                 submitButton.disabled = false;
                 submitButton.textContent = translations[currentLang]['submit_q'];
            }
        }
        
    </script>
</body>
</html>