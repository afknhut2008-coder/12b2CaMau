<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L·ªõp 12B2 - VIP Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS GIAO DI·ªÜN (ƒê√£ s·ª≠a ƒë·ªÉ Tab hi·ªán r√µ h∆°n) */
        :root { --primary: #6a11cb; --secondary: #2575fc; --bg: #f0f2f5; --white: #ffffff; --text: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); padding-bottom: 70px; color: var(--text); }
        
        .navbar { background: linear-gradient(to right, var(--primary), var(--secondary)); padding: 15px; position: sticky; top: 0; z-index: 100; color: white; font-weight: bold; display: flex; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 600px; margin: 15px auto; padding: 0 10px; }
        
        /* TABS */
        .tabs { display: flex; background: var(--white); padding: 5px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; border: none; background: none; padding: 10px; font-weight: bold; color: #777; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .section { display: none; animation: fadeUp 0.4s ease; }
        .section.active { display: block; }

        /* POST STYLES */
        .create-post { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cp-textarea { width: 100%; border: 1px solid #eee; border-radius: 10px; padding: 12px; outline: none; font-size: 1rem; resize: none; }
        .cp-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .btn-upload { background: #e4e6eb; color: #333; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-post { background: var(--primary); color: white; border: none; padding: 8px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; opacity: 0.9; transition: 0.3s; }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }
        
        .post { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: #666; }
        .post-author { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .post-img { width: 100%; border-radius: 8px; margin-top: 10px; object-fit: cover; }
        
        /* QUIZ STYLES */
        .quiz-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .quiz-stat { font-size: 0.9rem; color: #777; margin-bottom: 15px; }
        .question-box { font-size: 1.2rem; font-weight: bold; margin: 20px 0; min-height: 60px; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { padding: 15px; border: 1px solid #eee; background: white; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #f9f9f9; }
        .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .next-btn { margin-top: 20px; background: var(--secondary); color: white; border: none; padding: 10px 30px; border-radius: 25px; font-size: 1rem; cursor: pointer; display: none; }

        /* Loading Bar */
        #progress-container { width: 100%; background: #eee; height: 5px; margin-top: 10px; display: none; border-radius: 5px; overflow: hidden; }
        #progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onload="initQuiz()">

    <div class="navbar">
        <div>12B2 Official</div>
        <div onclick="location.reload()" style="cursor: pointer;"><i class="fas fa-sync-alt"></i></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('feed', this)">B·∫£ng tin</button>
            <button class="tab-btn" onclick="switchTab('quiz', this)">ƒê·ªë vui</button>
        </div>

        <div id="feed" class="section active">
            <div class="create-post">
                <textarea id="post-text" class="cp-textarea" rows="3" placeholder="Chia s·∫ª kho·∫£nh kh·∫Øc ho·∫∑c th√¥ng b√°o..."></textarea>
                
                <div id="progress-container"><div id="progress-bar"></div></div>
                <div id="upload-msg" style="font-size: 0.8rem; color: #666; margin-top: 5px; text-align: right;"></div>

                <div class="cp-actions">
                    <input type="file" id="file-input" accept="image/*,video/*" style="display: none;" onchange="checkFile()">
                    <div class="btn-upload" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-image" style="color: green;"></i> ·∫¢nh/Video (Max 10MB)
                    </div>
                    <button id="btn-submit" class="btn-post" onclick="uploadAndPost()">ƒêƒÉng</button>
                </div>
            </div>

            <div id="post-list">
                <div style="text-align: center; color: #888; margin-top: 20px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>

        <div id="quiz" class="section">
            <div class="quiz-card">
                <h2 style="color: var(--primary);">Th·ª≠ th√°ch tr√≠ tu·ªá üß†</h2>
                <div class="quiz-stat">ƒê√£ ho√†n th√†nh: <span id="done-count">0</span> c√¢u</div>
                
                <div id="quiz-content">
                    <div id="q-category" style="display: inline-block; background: #eee; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; margin-bottom: 10px;">Ch·ªß ƒë·ªÅ</div>
                    <div id="q-text" class="question-box">ƒêang t·∫£i c√¢u h·ªèi...</div>
                    <div id="options" class="options-grid"></div>
                    <button id="next-btn" class="next-btn" onclick="loadNextQuestion()">C√¢u ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                </div>

                <div id="quiz-complete" style="display: none; padding: 30px;">
                    <i class="fas fa-trophy" style="font-size: 3rem; color: gold; margin-bottom: 15px;"></i>
                    <h3>B·∫°n ƒë√£ tr·∫£ l·ªùi h·∫øt ng√¢n h√†ng c√¢u h·ªèi!</h3>
                    <p>H√£y quay l·∫°i sau khi Admin c·∫≠p nh·∫≠t th√™m nh√©.</p>
                    <button onclick="resetQuiz()" style="margin-top: 15px; padding: 10px 20px; border:1px solid #ddd; background:white; border-radius: 20px; cursor:pointer;">L√†m l·∫°i t·ª´ ƒë·∫ßu</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- K·∫æT N·ªêI FIREBASE (C·∫¨P NH·∫¨T TH√äM STORAGE) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // ‚ö†Ô∏è THAY TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const firebaseConfig = {
            apiKey: "AIzaSyBSqEO-mi650wMN2gwVac3nwLFtg4TTX80", // D√ÅN KEY C·ª¶A B·∫†N V√ÄO
            authDomain: "b2-6431c.firebaseapp.com",
            projectId: "b2-6431c",
            storageBucket: "b2-6431c.appspot.com", // ƒê√É S·ª¨A TH√ÄNH APPSPOT.COM CHU·∫®N
            messagingSenderId: "164059778488",
            appId: "1:164059778488:web:9eca97e23ab644df48534d",
            measurementId: "G-19QWD4RCYC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const postsRef = collection(db, "posts_12b2");

        // --- H√ÄM CHUY·ªÇN TAB ---
        window.switchTab = function(tabId, element) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
            if(tabId === 'quiz') initQuiz();
        }

        // --- PH·∫¶N 1: X·ª¨ L√ù ƒêƒÇNG B√ÄI & ·∫¢NH L·ªöN (STORAGE) ---
        
        window.checkFile = function() {
            const file = document.getElementById('file-input').files[0];
            if(file) {
                document.getElementById('upload-msg').innerText = `ƒê√£ ch·ªçn: ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`;
            }
        }

        window.uploadAndPost = async function() {
            const text = document.getElementById('post-text').value;
            const file = document.getElementById('file-input').files[0];
            const btn = document.getElementById('btn-submit');
            
            if (!text && !file) return alert("Ch∆∞a nh·∫≠p n·ªôi dung!");

            btn.disabled = true;
            btn.innerText = "ƒêang x·ª≠ l√Ω...";

            let downloadURL = null;

            try {
                // 1. N·∫øu c√≥ ·∫£nh -> Upload l√™n Storage
                if (file) {
                    if (file.size > 10 * 1024 * 1024) throw new Error("File qu√° l·ªõn (> 10MB)!");
                    
                    document.getElementById('progress-container').style.display = 'block';
                    const storageRef = ref(storage, 'uploads/' + new Date().getTime() + '_' + file.name);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    // X·ª≠ l√Ω Promise ƒë·ªÉ ƒë·ª£i upload xong
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                document.getElementById('progress-bar').style.width = progress + '%';
                                document.getElementById('upload-msg').innerText = `ƒêang t·∫£i l√™n: ${Math.round(progress)}%`;
                            }, 
                            (error) => reject(error), 
                            () => resolve()
                        );
                    });

                    downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                }

                // 2. L∆∞u b√†i vi·∫øt v√†o Firestore (ch·ª©a link ·∫£nh)
                await addDoc(postsRef, {
                    text: text,
                    imageUrl: downloadURL, // Link ·∫£nh l·∫•y t·ª´ Storage
                    fileType: file ? file.type : null,
                    createdAt: serverTimestamp(),
                    author: "Th√†nh vi√™n l·ªõp"
                });

                // Reset
                document.getElementById('post-text').value = '';
                document.getElementById('file-input').value = '';
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('upload-msg').innerText = '';
                alert("ƒêƒÉng th√†nh c√¥ng!");

            } catch (error) {
                console.error(error);
                alert("L·ªói: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ƒêƒÉng";
            }
        }

        // --- LOAD B√ÄI VI·∫æT REALTIME ---
        onSnapshot(query(postsRef, orderBy("createdAt", "desc")), (snapshot) => {
            const list = document.getElementById("post-list");
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const p = doc.data();
                const date = p.createdAt ? new Date(p.createdAt.seconds*1000).toLocaleString('vi-VN') : 'V·ª´a xong';
                
                let mediaHtml = "";
                if(p.imageUrl) {
                    if(p.fileType && p.fileType.includes('video')) {
                        mediaHtml = `<video src="${p.imageUrl}" controls class="post-img"></video>`;
                    } else {
                        mediaHtml = `<img src="${p.imageUrl}" class="post-img" loading="lazy">`;
                    }
                }

                list.innerHTML += `
                    <div class="post">
                        <div class="post-header">
                            <span class="post-author"><i class="fas fa-user-circle"></i> ${p.author}</span>
                            <span>${date}</span>
                        </div>
                        <div style="font-size: 1rem; line-height: 1.5;">${p.text}</div>
                        ${mediaHtml}
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; display: flex; gap: 20px; color: #666;">
                            <span><i class="far fa-heart"></i> Th√≠ch</span>
                            <span><i class="far fa-comment"></i> B√¨nh lu·∫≠n</span>
                        </div>
                    </div>`;
            });
        });


        // --- PH·∫¶N 2: QUIZ TH√îNG MINH (C·∫¨P NH·∫¨T & KH√îNG TR√ôNG) ---
        
        // NG√ÇN H√ÄNG C√ÇU H·ªéI (B·∫°n c√≥ th·ªÉ th√™m bao nhi√™u t√πy th√≠ch v√†o ƒë√¢y)
        const fullQuestionBank = [
            { id: 1, cat: "To√°n", q: "T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë y = log(x)?", a: ["(0; +‚àû)", "[0; +‚àû)", "R", "R\\{0}"], c: 0 },
            { id: 2, cat: "L√Ω", q: "Trong ch√¢n kh√¥ng, v·∫≠n t·ªëc √°nh s√°ng l√†?", a: ["3.10^8 m/s", "340 m/s", "3.10^5 km/h", "V√¥ c·ª±c"], c: 0 },
            { id: 3, cat: "H√≥a", q: "Dung d·ªãch l√†m qu·ª≥ t√≠m chuy·ªÉn ƒë·ªè?", a: ["NaOH", "HCl", "NaCl", "C2H5OH"], c: 1 },
            { id: 4, cat: "S·ª≠", q: "Vi·ªát Nam gia nh·∫≠p ASEAN nƒÉm n√†o?", a: ["1990", "1995", "2000", "1986"], c: 1 },
            { id: 5, cat: "ƒê·ªãa", q: "T·ªânh n√†o c√≥ di·ªán t√≠ch l·ªõn nh·∫•t VN?", a: ["Thanh H√≥a", "Ngh·ªá An", "Gia Lai", "L√¢m ƒê·ªìng"], c: 1 },
            { id: 6, cat: "B√≥ng ƒê√°", q: "CLB n√†o v√¥ ƒë·ªãch C1 nƒÉm 2023?", a: ["Real Madrid", "Man City", "Inter Milan", "Liverpool"], c: 1 },
            { id: 7, cat: "Tin H·ªçc", q: "Ph√≠m t·∫Øt Copy l√† g√¨?", a: ["Ctrl+V", "Ctrl+C", "Ctrl+X", "Alt+F4"], c: 1 },
            { id: 8, cat: "VƒÉn", q: "T√°c gi·∫£ c·ªßa 'S√≥ng' l√†?", a: ["Xu√¢n Qu·ª≥nh", "H√†n M·∫∑c T·ª≠", "Huy C·∫≠n", "T·ªë H·ªØu"], c: 0 },
            // TH√äM C√ÇU M·ªöI ·ªû D∆Ø·ªöI ƒê√ÇY, NH·ªö ƒê·ªîI S·ªê ID KH√ÅC NHAU NH√â
            { id: 9, cat: "ƒê·ªùi s·ªëng", q: "L·ªõp 12B2 c√≥ bao nhi√™u th√†nh vi√™n?", a: ["38", "39", "40", "45"], c: 0 }, 
        ];

        // Bi·∫øn to√†n c·ª•c
        let availableQuestions = [];

        window.initQuiz = function() {
            // 1. L·∫•y danh s√°ch ID ƒë√£ l√†m t·ª´ b·ªô nh·ªõ m√°y
            const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids')) || [];
            document.getElementById('done-count').innerText = doneIds.length;

            // 2. L·ªçc ra nh·ªØng c√¢u CH∆ØA l√†m
            availableQuestions = fullQuestionBank.filter(q => !doneIds.includes(q.id));

            if(availableQuestions.length === 0) {
                document.getElementById('quiz-content').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
            } else {
                document.getElementById('quiz-content').style.display = 'block';
                document.getElementById('quiz-complete').style.display = 'none';
                loadNextQuestion();
            }
        }

        window.loadNextQuestion = function() {
            if(availableQuestions.length === 0) { initQuiz(); return; }

            document.getElementById('next-btn').style.display = 'none';
            
            // Random c√¢u h·ªèi
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const qData = availableQuestions[randomIndex];
            
            // Hi·ªÉn th·ªã
            document.getElementById('q-category').innerText = qData.cat;
            document.getElementById('q-text').innerText = qData.q;
            
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            
            qData.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = ans;
                btn.onclick = () => checkAnswer(btn, qData, idx);
                optDiv.appendChild(btn);
            });
        }

        window.checkAnswer = function(btn, qData, selectedIdx) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true); // Kh√≥a n√∫t

            if(selectedIdx === qData.c) {
                btn.classList.add('correct');
                // L∆∞u ID v√†o b·ªô nh·ªõ ƒë·ªÉ kh√¥ng h·ªèi l·∫°i
                const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids')) || [];
                if(!doneIds.includes(qData.id)) {
                    doneIds.push(qData.id);
                    localStorage.setItem('quiz_done_ids', JSON.stringify(doneIds));
                }
            } else {
                btn.classList.add('wrong');
                allBtns[qData.c].classList.add('correct'); // Hi·ªán ƒë√°p √°n ƒë√∫ng
            }
            
            document.getElementById('next-btn').style.display = 'inline-block';
            
            // X√≥a c√¢u v·ª´a l√†m kh·ªèi danh s√°ch t·∫°m th·ªùi ƒë·ªÉ next ngay c√¢u kh√°c
            availableQuestions = availableQuestions.filter(q => q.id !== qData.id);
        }

        window.resetQuiz = function() {
            if(confirm("B·∫°n c√≥ mu·ªën x√≥a l·ªãch s·ª≠ ƒë·ªÉ l√†m l·∫°i t·ª´ ƒë·∫ßu?")) {
                localStorage.removeItem('quiz_done_ids');
                initQuiz();
            }
        }
    </script>
</body>
</html>