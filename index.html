<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>12B2 - C·ªông ƒê·ªìng & Tu·ªïi Th∆°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS CHUNG V√Ä HI·ªÜU ·ª®NG M·ªöI (C·∫¨P NH·∫¨T UI ƒê·∫∏P H∆†N) */
        :root { 
            --primary-color: #2193b0;
            --secondary-color: #fc4a1a;
            --primary-gradient: linear-gradient(135deg, #6dd5ed, var(--primary-color)); 
            --secondary-gradient: linear-gradient(135deg, #f7b733, var(--secondary-color)); 
            --button-hover: linear-gradient(135deg, #4facfe, #00f2fe); 
            --bg-color: #f0f2f5; 
            --card-bg: #ffffff; 
            --text-color: #333; 
            --light-text-color: #666;
            --border-color: #e0e0e0;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); 
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.12);
            --radius-large: 20px;
            --radius-medium: 12px;
            --radius-small: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; }
        body { 
            background: var(--bg-color); 
            padding-bottom: 70px; 
            color: var(--text-color); 
            min-height: 100vh;
        }
        
        /* HI·ªÜU ·ª®NG N·ªÄN ƒê·ªòNG (NH·∫∏ NH√ÄNG) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(109, 213, 237, 0.1) 0%, rgba(33, 147, 176, 0.05) 50%, transparent 100%);
            z-index: -1;
            animation: gradientMove 15s ease infinite alternate;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .navbar { 
            background: var(--primary-gradient); 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            color: white; 
            font-weight: 700; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow-medium); 
            border-bottom-left-radius: var(--radius-large);
            border-bottom-right-radius: var(--radius-large);
        }
        .container { max-width: 650px; margin: 20px auto; padding: 0 15px; }
        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: var(--radius-large); /* Bo g√≥c l·ªõn h∆°n */
            margin-bottom: 25px; 
            box-shadow: var(--shadow-light); 
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .card:hover { 
            transform: translateY(-3px); /* Gi·∫£m ƒë·ªô n·∫£y ƒë·ªÉ tr√¥ng chuy√™n nghi·ªáp h∆°n */
            box-shadow: var(--shadow-medium); 
        }
        
        /* INPUTS & BUTTONS */
        input[type="text"], textarea, select, input[type="number"] {
            border-radius: var(--radius-medium); 
        }
        .btn-send, .next-btn, .game-button { 
            border-radius: 50px; /* N√∫t tr√≤n h∆°n, hi·ªán ƒë·∫°i h∆°n */
        }

        /* QUIZ SCORE DISPLAY M·ªöI */
        .quiz-stat { 
            font-size: 1rem; 
            color: var(--light-text-color); 
            margin-bottom: 15px; 
            line-height: 1.6; 
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .quiz-stat-item {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: var(--radius-large);
            font-weight: 600;
        }
        #current-score {
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba;
        }
        #done-count {
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
            margin-right: 10px;
        }
        .quiz-stat i { margin-right: 5px; }


        /* CHAT/MESSAGE LIKES M·ªöI */
        .post-likes {
            display: flex;
            align-items: center;
            color: var(--light-text-color);
            cursor: pointer;
            transition: color 0.2s;
            font-size: 0.95rem;
            margin-top: 10px; /* T·∫°o kho·∫£ng c√°ch v·ªõi n·ªôi dung */
            user-select: none;
        }
        .post-likes i {
            margin-right: 5px;
            color: #ccc;
            transition: color 0.3s, transform 0.1s;
        }
        .post-likes i.liked {
            color: #dc3545; /* M√†u ƒë·ªè cho n√∫t ƒë√£ th√≠ch */
            transform: scale(1.1);
        }
        .post-likes:hover i {
            color: #dc3545;
        }
        
        /* GAME GH√âP C·∫∂P (MEMORY MATCH) M·ªöI */
        #memory-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        .memory-card {
            background-color: var(--primary-color);
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--radius-medium);
            cursor: pointer;
            perspective: 1000px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .memory-card.flip {
            transform: rotateY(180deg);
        }
        .memory-card.match {
            opacity: 0.5;
            cursor: default;
        }
        .memory-card.match .card-face {
            color: #28a745;
        }

        .card-face {
            position: absolute;
            backface-visibility: hidden;
            font-size: 2.5rem;
            color: white;
            font-weight: 700;
        }
        .front-face {
            transform: rotateY(180deg);
            color: var(--text-color);
        }

        /* Responsive cho game gh√©p c·∫∑p */
        @media (max-width: 480px) {
            .memory-card {
                height: 60px;
            }
            .card-face {
                font-size: 1.8rem;
            }
        }
        
        /* Th√™m c√°c icon cho game gh√©p c·∫∑p */
        .memory-card .front-face i {
            transition: color 0.3s;
        }
        
        /* Skeleton Screen cho Quiz */
        .skeleton {
            background: #e0e0e0;
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 5px;
            background-size: 200% 100%;
            animation: 1.5s shine linear infinite;
        }
        @keyframes shine {
            to { background-position: -200% 0; }
        }
        .skeleton-text-lg { height: 25px; margin-bottom: 20px; width: 90%; }
        .skeleton-button { height: 40px; margin-bottom: 12px; }

        /* Animation chung */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .post { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body onload="initApp()">

    <div class="navbar">
        <div>12B2 <span data-i18n="community">C·ªông ƒê·ªìng</span></div>
        <div style="display: flex; align-items: center;">
            <a href="https://www.tiktok.com/@12b2thptcamau?is_from_webapp=1&sender_device=pc" target="_blank" style="font-size: 1.2rem;" title="TikTok c·ªßa l·ªõp"><i class="fab fa-tiktok"></i></a>
            <div id="lang-switch" onclick="toggleLanguage()">VI / EN</div>
        </div>
    </div>

    <div class="container">

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="social" onclick="showTab('social')" data-i18n="social_tab">Social & Quiz</button>
            <button class="tab-btn" data-tab="games" onclick="showTab('games')" data-i18n="game_tab">Games (Tu·ªïi Th∆°)</button>
        </div>

        <div id="social" class="tab-content">

            <h3><i class="fas fa-comments"></i> <span data-i18n="chat_title">G√≥c Chat ·∫®n Danh</span></h3>
            <div class="create-message card">
                <textarea id="message-text" rows="3" data-i18n-placeholder="chat_placeholder" placeholder="G·ª≠i tin nh·∫Øn ·∫©n danh cho c·∫£ l·ªõp..."></textarea>
                <div class="msg-actions">
                    <button id="btn-send-msg" class="btn-send" onclick="sendMessage()" data-i18n="send_msg">G·ª≠i tin nh·∫Øn</button>
                </div>
            </div>
            
            <div id="message-list">
                <div class="card" style="padding: 15px;">
                    <div class="skeleton" style="width: 50%; height: 15px; margin-bottom: 10px;"></div>
                    <div class="skeleton" style="width: 100%; height: 10px; margin-bottom: 5px;"></div>
                    <div class="skeleton" style="width: 80%; height: 10px;"></div>
                </div>
            </div>
            
            <button id="load-more-btn" class="btn-send" onclick="loadMoreMessages()" data-i18n="load_more_msg" style="display: none;">Xem th√™m tin nh·∫Øn</button>


            <hr>

            <h3><i class="fas fa-brain"></i> <span data-i18n="quiz_title">Th·ª≠ Th√°ch ƒê·ªë Vui</span></h3>
            
            <div id="name-input-section" class="card">
                <h4 data-i18n="name_prompt">B·∫Øt ƒë·∫ßu Quiz! Vui l√≤ng nh·∫≠p t√™n (ƒë·ªÉ l√™n BXH):</h4>
                <input type="text" id="user-name-input" data-i18n-placeholder="name_placeholder" placeholder="T√™n c·ªßa b·∫°n (v√≠ d·ª•: Nam K·∫ø To√°n)">
                <button onclick="saveUserName()" data-i18n="start_quiz">B·∫Øt ƒë·∫ßu Quiz</button>
            </div>

            <div id="quiz-section" style="display: none;">
                <div class="quiz-card card">
                    <div class="quiz-stat">
                        <span data-i18n="welcome">Ch√†o m·ª´ng</span>, <span id="current-user-display" style="color: var(--primary-color); font-weight: bold;"></span>!
                        <div>
                            <span class="quiz-stat-item" id="done-count-container"><i class="fas fa-check-circle"></i> <span data-i18n="completed">ƒê√£ xong</span>: <span id="done-count">0</span></span>
                            <span class="quiz-stat-item" id="score-count-container"><i class="fas fa-star"></i> <span data-i18n="score">ƒêi·ªÉm</span>: <span id="current-score">0</span></span>
                        </div>
                    </div>
                    
                    <div id="quiz-content">
                        <div id="q-category" data-i18n="topic">Ch·ªß ƒë·ªÅ</div>
                        <div id="q-text" class="question-box">
                            <div class="skeleton skeleton-text-lg"></div>
                        </div>
                        <div id="options" class="options-grid">
                            <div class="skeleton skeleton-button"></div>
                            <div class="skeleton skeleton-button"></div>
                            <div class="skeleton skeleton-button"></div>
                            <div class="skeleton skeleton-button"></div>
                        </div>
                        <button id="next-btn" class="next-btn" onclick="loadNextQuestion()" data-i18n="next_q" style="display: none;">C√¢u ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
                    </div>

                    <div id="quiz-complete" style="display: none; padding: 30px; text-align: center;">
                        <i class="fas fa-trophy" style="font-size: 3.5rem; color: gold; margin-bottom: 20px;"></i>
                        <h3 style="justify-content: center;"><span data-i18n="quiz_done_h3">Ho√†n th√†nh!</span></h3>
                        <p style="margin-bottom: 20px;"><span data-i18n="final_score_p">T·ªïng ƒëi·ªÉm c·ªßa b·∫°n</span>: <strong id="final-score-display"></strong>. <span data-i18n="sending_rank">ƒêang g·ª≠i k·∫øt qu·∫£ l√™n BXH...</span></p>
                        <button onclick="resetQuiz()" data-i18n="play_again" class="btn-send" style="background: #e0e0e0; color: var(--text-color); width: auto;">L√†m l·∫°i</button>
                    </div>
                </div>
            </div>

            <hr>

            <h3><i class="fas fa-plus-circle"></i> <span data-i18n="create_q_title">T·∫°o C√¢u H·ªèi M·ªõi</span></h3>
            <div id="create-question-section" class="card">
                <h4 data-i18n="contribute_q">ƒê√≥ng g√≥p Quiz (C√¢u h·ªèi ƒë∆∞·ª£c d√πng ngay):</h4>
                <input type="text" id="q-text-input" data-i18n-placeholder="q_content_ph" placeholder="N·ªôi dung C√¢u h·ªèi">
                <input type="text" id="q-ans-0" data-i18n-placeholder="ans_a_ph" placeholder="ƒê√°p √°n A">
                <input type="text" id="q-ans-1" data-i18n-placeholder="ans_b_ph" placeholder="ƒê√°p √°n B">
                <input type="text" id="q-ans-2" data-i18n-placeholder="ans_c_ph" placeholder="ƒê√°p √°n C">
                <input type="text" id="q-ans-3" data-i18n-placeholder="ans_d_ph" placeholder="ƒê√°p √°n D">
                <select id="q-correct-select">
                    <option value="-1" data-i18n="select_correct_ans">Ch·ªçn ƒê√°p √°n ƒê√∫ng</option>
                    <option value="0" data-i18n="ans_a_correct">ƒê√°p √°n A l√† ƒë√∫ng</option>
                    <option value="1" data-i18n="ans_b_correct">ƒê√°p √°n B l√† ƒë√∫ng</option>
                    <option value="2" data-i18n="ans_c_correct">ƒê√°p √°n C l√† ƒë√∫ng</option>
                    <option value="3" data-i18n="ans_d_correct">ƒê√°p √°n D l√† ƒë√∫ng</option>
                </select>
                <input type="text" id="q-cat-input" data-i18n-placeholder="category_ph" placeholder="Ch·ªß ƒë·ªÅ (v√≠ d·ª•: To√°n, L√Ω)">
                <button class="btn-send" style="width: 100%;" onclick="submitUserQuestion()" data-i18n="submit_q">G·ª≠i ƒë√≥ng g√≥p</button>
            </div>
            
            <hr>

            <h3><i class="fas fa-trophy"></i> <span data-i18n="leaderboard_title">B·∫£ng X·∫øp H·∫°ng (Top 10)</span></h3>
            <div id="leaderboard-section" class="card">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th data-i18n="rank">H·∫°ng</th>
                            <th data-i18n="name">T√™n</th>
                            <th data-i18n="score">ƒêi·ªÉm</th>
                            <th data-i18n="date">Ng√†y ch∆°i</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" style="text-align: center;" data-i18n="loading_rank">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</td></tr>
                    </tbody>
                </table>
            </div>

        </div> 

        <div id="games" class="tab-content" style="display: none;">
            <h3 style="margin-bottom: 25px;"><i class="fas fa-gamepad"></i> <span data-i18n="game_h3">Khu V·ª±c Tr√≤ Ch∆°i Tu·ªïi Th∆°</span></h3>
            
            <div class="guessing-wrapper card">
                <h4 data-i18n="memory_title">Game Gh√©p C·∫∑p (Memory Match)</h4>
                <p id="memory-status" style="margin-bottom: 15px; font-weight: 600;" data-i18n="memory_status_start">B·∫•m "Ch∆°i m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
                <div id="memory-game-board">
                    </div>
                <button id="memory-new-game-button" class="game-button" onclick="startMemoryGame()" data-i18n="memory_new_game">Ch∆°i m·ªõi</button>
            </div>

            <div class="tictactoe-wrapper card">
                <h4 data-i18n="tictactoe_title">Ch∆°i C·ªù Caro (Tic-Tac-Toe)</h4>
                <div id="tictactoe-status" data-i18n="tictactoe_status_x">L∆∞·ª£t c·ªßa X</div>
                <div id="tictactoe-board">
                    <div class="cell" data-index="0"></div>
                    <div class="cell" data-index="1"></div>
                    <div class="cell" data-index="2"></div>
                    <div class="cell" data-index="3"></div>
                    <div class="cell" data-index="4"></div>
                    <div class="cell" data-index="5"></div>
                    <div class="cell" data-index="6"></div>
                    <div class="cell" data-index="7"></div>
                    <div class="cell" data-index="8"></div>
                </div>
                <button id="tictactoe-reset" data-i18n="tictactoe_reset" onclick="resetGame()">Ch∆°i l·∫°i</button>
            </div>

            <div class="guessing-wrapper card">
                <h4 data-i18n="guessing_title">Game ƒêo√°n S·ªë (1-100)</h4>
                <p data-i18n="guessing_prompt">T√¥i ƒë√£ ch·ªçn m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 100. B·∫°n c√≥ 10 l·∫ßn ƒëo√°n!</p>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <input type="number" id="guess-input" min="1" max="100" data-i18n-placeholder="guess_ph" placeholder="Nh·∫≠p s·ªë">
                    <button id="guess-button" class="game-button" onclick="checkGuess()" data-i18n="guess_btn">ƒêo√°n</button>
                </div>
                <div id="guess-result"></div>
                <div id="guess-log"></div>
                <button id="new-game-button" class="game-button" onclick="startNewGuessingGame()" data-i18n="new_game_btn" style="background: var(--secondary-color); margin-top: 15px;">Ch∆°i l·∫°i</button>
            </div>
            
        </div> 
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, query, orderBy, onSnapshot, serverTimestamp, getDocs, limit, startAfter } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- D·ªÆ LI·ªÜU ƒêA NG√îN NG·ªÆ ---
        const translations = {
            'vi': {
                'community': 'C·ªông ƒê·ªìng',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Tu·ªïi Th∆°)',
                'chat_title': 'G√≥c Chat ·∫®n Danh',
                'chat_placeholder': 'G·ª≠i tin nh·∫Øn ·∫©n danh cho c·∫£ l·ªõp...',
                'send_msg': 'G·ª≠i tin nh·∫Øn',
                'loading_msg': 'ƒêang t·∫£i tin nh·∫Øn...',
                'load_more_msg': 'Xem th√™m tin nh·∫Øn',
                'quiz_title': 'Th·ª≠ Th√°ch ƒê·ªë Vui',
                'name_prompt': 'B·∫Øt ƒë·∫ßu Quiz! Vui l√≤ng nh·∫≠p t√™n (ƒë·ªÉ l√™n BXH):',
                'name_placeholder': 'T√™n c·ªßa b·∫°n (v√≠ d·ª•: Nam K·∫ø To√°n)',
                'start_quiz': 'B·∫Øt ƒë·∫ßu Quiz',
                'welcome': 'Ch√†o m·ª´ng',
                'completed': 'ƒê√£ ho√†n th√†nh',
                'score': 'ƒêi·ªÉm',
                'topic': 'Ch·ªß ƒë·ªÅ',
                'next_q': 'C√¢u ti·∫øp theo',
                'quiz_done_h3': 'Ho√†n th√†nh!',
                'final_score_p': 'T·ªïng ƒëi·ªÉm c·ªßa b·∫°n',
                'sending_rank': 'ƒêang g·ª≠i k·∫øt qu·∫£ l√™n BXH...',
                'play_again': 'L√†m l·∫°i',
                'create_q_title': 'T·∫°o C√¢u H·ªèi M·ªõi',
                'contribute_q': 'ƒê√≥ng g√≥p Quiz (C√¢u h·ªèi ƒë∆∞·ª£c d√πng ngay):',
                'q_content_ph': 'N·ªôi dung C√¢u h·ªèi',
                'ans_a_ph': 'ƒê√°p √°n A', 'ans_b_ph': 'ƒê√°p √°n B', 'ans_c_ph': 'ƒê√°p √°n C', 'ans_d_ph': 'ƒê√°p √°n D',
                'select_correct_ans': 'Ch·ªçn ƒê√°p √°n ƒê√∫ng',
                'ans_a_correct': 'ƒê√°p √°n A l√† ƒë√∫ng', 'ans_b_correct': 'ƒê√°p √°n B l√† ƒë√∫ng', 'ans_c_correct': 'ƒê√°p √°n C l√† ƒë√∫ng', 'ans_d_correct': 'ƒê√°p √°n D l√† ƒë√∫ng',
                'category_ph': 'Ch·ªß ƒë·ªÅ (v√≠ d·ª•: To√°n, L√Ω)',
                'submit_q': 'G·ª≠i ƒë√≥ng g√≥p',
                'leaderboard_title': 'B·∫£ng X·∫øp H·∫°ng (Top 10)',
                'rank': 'H·∫°ng', 'name': 'T√™n', 'date': 'Ng√†y ch∆°i',
                'loading_rank': 'ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...',
                'game_h3': 'Khu V·ª±c Tr√≤ Ch∆°i Tu·ªïi Th∆°',
                'tictactoe_title': 'Ch∆°i C·ªù Caro (Tic-Tac-Toe)',
                'tictactoe_status_x': 'L∆∞·ª£t c·ªßa X',
                'tictactoe_status_o': 'L∆∞·ª£t c·ªßa O',
                'tictactoe_win_x': 'X th·∫Øng! ü•≥',
                'tictactoe_win_o': 'O th·∫Øng! ü•≥',
                'tictactoe_draw': 'H√≤a! ü§ù',
                'tictactoe_reset': 'Ch∆°i l·∫°i',
                'guessing_title': 'Game ƒêo√°n S·ªë (1-100)',
                'guessing_prompt': 'T√¥i ƒë√£ ch·ªçn m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 100. B·∫°n c√≥ 10 l·∫ßn ƒëo√°n!',
                'guess_ph': 'Nh·∫≠p s·ªë',
                'guess_btn': 'ƒêo√°n',
                'new_game_btn': 'Ch∆°i m·ªõi',
                'guess_too_low': 'Qu√° th·∫•p! ü§è',
                'guess_too_high': 'Qu√° cao! üëÜ',
                'guess_win': 'üéâ CH√öC M·ª™NG! B·∫°n ƒëo√°n ƒë√∫ng s·ªë %s ch·ªâ trong %t l·∫ßn!',
                'guess_lose': 'GAME OVER! B·∫°n ƒë√£ h·∫øt l·∫ßn ƒëo√°n. S·ªë b√≠ m·∫≠t l√† %s.',
                'guess_try_left': 'B·∫°n c√≤n %t l·∫ßn ƒëo√°n.',
                'guess_input_invalid': 'Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá t·ª´ 1 ƒë·∫øn 100.',
                'anonymous': '·∫®n danh',
                'memory_title': 'Game Gh√©p C·∫∑p (Memory Match)',
                'memory_status_start': 'B·∫•m "Ch∆°i m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu!',
                'memory_status_win': 'üéâ CHI·∫æN TH·∫ÆNG! B·∫°n ƒë√£ gh√©p ƒë√∫ng t·∫•t c·∫£ c√°c c·∫∑p!',
                'memory_status_turn': 'L∆∞·ª£t ƒëi: %t',
                'memory_new_game': 'Ch∆°i m·ªõi',
            },
            'en': {
                'community': 'Community',
                'social_tab': 'Social & Quiz',
                'game_tab': 'Games (Childhood)',
                'chat_title': 'Anonymous Chat Corner',
                'chat_placeholder': 'Send an anonymous message to the class...',
                'send_msg': 'Send Message',
                'loading_msg': 'Loading messages...',
                'load_more_msg': 'Load more messages',
                'quiz_title': 'Quiz Challenge',
                'name_prompt': 'Start Quiz! Please enter your name (for Leaderboard):',
                'name_placeholder': 'Your name (e.g., John Doe)',
                'start_quiz': 'Start Quiz',
                'welcome': 'Welcome',
                'completed': 'Completed',
                'score': 'Score',
                'topic': 'Topic',
                'next_q': 'Next Question',
                'quiz_done_h3': 'Finished!',
                'final_score_p': 'Your total score',
                'sending_rank': 'Submitting score to Leaderboard...',
                'play_again': 'Play Again',
                'create_q_title': 'Create New Question',
                'contribute_q': 'Contribute Quiz (Question is used immediately):',
                'q_content_ph': 'Question Content',
                'ans_a_ph': 'Answer A', 'ans_b_ph': 'Answer B', 'ans_c_ph': 'Answer C', 'ans_d_ph': 'Answer D',
                'select_correct_ans': 'Select Correct Answer',
                'ans_a_correct': 'Answer A is correct', 'ans_b_correct': 'Answer B is correct', 'ans_c_correct': 'Answer C is correct', 'ans_d_correct': 'Answer D is correct',
                'category_ph': 'Category (e.g., Math, Physics)',
                'submit_q': 'Submit Contribution',
                'leaderboard_title': 'Leaderboard (Top 10)',
                'rank': 'Rank', 'name': 'Name', 'date': 'Play Date',
                'loading_rank': 'Loading leaderboard...',
                'game_h3': 'Childhood Games Zone',
                'tictactoe_title': 'Play Tic-Tac-Toe',
                'tictactoe_status_x': 'X\'s turn',
                'tictactoe_status_o': 'O\'s turn',
                'tictactoe_win_x': 'X wins! ü•≥',
                'tictactoe_win_o': 'O wins! ü•≥',
                'tictactoe_draw': 'Draw! ü§ù',
                'tictactoe_reset': 'Play Again',
                'guessing_title': 'Number Guessing Game (1-100)',
                'guessing_prompt': 'I have picked a number between 1 and 100. You have 10 tries!',
                'guess_ph': 'Enter number',
                'guess_btn': 'Guess',
                'new_game_btn': 'New Game',
                'guess_too_low': 'Too low! ü§è',
                'guess_too_high': 'Too high! üëÜ',
                'guess_win': 'üéâ CONGRATS! You guessed %s in %t tries!',
                'guess_lose': 'GAME OVER! You ran out of tries. The secret number was %s.',
                'guess_try_left': 'You have %t tries left.',
                'guess_input_invalid': 'Please enter a valid number between 1 and 100.',
                'anonymous': 'Anonymous',
                'memory_title': 'Memory Match Game',
                'memory_status_start': 'Click "New Game" to start!',
                'memory_status_win': 'üéâ CONGRATS! You matched all pairs!',
                'memory_status_turn': 'Turns: %t',
                'memory_new_game': 'New Game',
            }
        };

        let currentLang = localStorage.getItem('appLang') || 'vi';

        window.toggleLanguage = function() {
            currentLang = currentLang === 'vi' ? 'en' : 'vi';
            localStorage.setItem('appLang', currentLang);
            applyLanguage(currentLang);
            updateGameStatusDisplay();
            startNewGuessingGame(); 
            startMemoryGame(true); // Kh·ªüi t·∫°o l·∫°i game gh√©p c·∫∑p
            loadInitialMessages(); 
        }

        function applyLanguage(lang) {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = translations[lang][key];
            });

            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = translations[lang][key];
            });
            
            loadLeaderboard(); 
        }
        
        // --- LOGIC TAB CON ---
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'games' && !window.gamesInitialized) {
                initTicTacToe();
                startNewGuessingGame();
                startMemoryGame(true);
                window.gamesInitialized = true;
            }
        }

        // ‚ö†Ô∏è THAY TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const firebaseConfig = {
            apiKey: "AIzaSyBSqEO-mi650wMN2gwVac3nwLFtg4TTX80", 
            authDomain: "b2-6431c.firebaseapp.com",
            projectId: "b2-6431c",
            storageBucket: "b2-6431c.appspot.com",
            messagingSenderId: "164059778488",
            appId: "1:164059778488:web:9eca97e23ab644df48534d",
            measurementId: "G-19QWD4RCYC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // C√ÅC COLLECTIONS S·ª¨ D·ª§NG
        const chatRef = collection(db, "anonymous_messages");
        const quizRef = collection(db, "quiz_questions"); 
        const leaderboardRef = collection(db, "quiz_leaderboard"); 

        // BI·∫æN TO√ÄN C·ª§C QUIZ
        let availableQuestions = [];
        let fullQuestionBank = [];
        let currentScore = 0;
        let questionsAttempted = 0;
        let currentUserName = localStorage.getItem('userName12B2') || null;

        // BI·∫æN CHAT PH√ÇN TRANG
        let lastVisible = null;
        const MESSAGE_LIMIT = 5;

        // --- H√ÄM KH·ªûI T·∫†O CHUNG (CH·∫†Y KHI T·∫¢I TRANG) ---
        window.initApp = function() {
            applyLanguage(currentLang);
            loadLeaderboard();
            loadInitialMessages(); 
            if (currentUserName) {
                document.getElementById('current-user-display').innerText = currentUserName;
                document.getElementById('name-input-section').style.display = 'none';
                document.getElementById('quiz-section').style.display = 'block';
                initQuiz();
            } else {
                document.getElementById('name-input-section').style.display = 'block';
                document.getElementById('quiz-section').style.display = 'none';
            }
            // Kh·ªüi t·∫°o Games khi chuy·ªÉn tab l·∫ßn ƒë·∫ßu
            // initTicTacToe(); 
            // startNewGuessingGame(); 
            // startMemoryGame(true);
        }

        // --- LOGIC CHAT PH√ÇN TRANG & LIKE M·ªöI ---
        
        async function loadInitialMessages() {
            const list = document.getElementById("message-list");
            list.innerHTML = `<div style="text-align: center; color: var(--light-text-color); margin-top: 20px;">${translations[currentLang]['loading_msg']}</div>`;
            lastVisible = null; 

            // L·∫Øng nghe realtime cho 1 tin nh·∫Øn m·ªõi nh·∫•t 
            onSnapshot(query(chatRef, orderBy("createdAt", "desc"), limit(1)), (snapshot) => {
                if(snapshot.empty) return;
                const latestDocId = snapshot.docs[0].id;
                
                const firstMsgElement = list.querySelector('.post.card:first-child');
                if (firstMsgElement && firstMsgElement.getAttribute('data-doc-id') === latestDocId) {
                    return;
                }
                
                // T·∫£i l·∫°i 5 tin ƒë·∫ßu n·∫øu c√≥ tin nh·∫Øn m·ªõi h∆°n 
                loadMoreMessages(true);
            });

            // T·∫£i 5 tin nh·∫Øn ƒë·∫ßu ti√™n (kh√¥ng ph·∫£i realtime)
            await loadMoreMessages(true);
        }

        window.loadMoreMessages = async function(isInitialLoad = false) {
            const list = document.getElementById("message-list");
            const loadMoreBtn = document.getElementById('load-more-btn');
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = isInitialLoad ? translations[currentLang]['loading_msg'] : (currentLang === 'vi' ? "ƒêang t·∫£i..." : "Loading...");

            let q = query(chatRef, orderBy("createdAt", "desc"), limit(MESSAGE_LIMIT));
            if (lastVisible && !isInitialLoad) {
                q = query(chatRef, orderBy("createdAt", "desc"), startAfter(lastVisible), limit(MESSAGE_LIMIT));
            }
            
            try {
                const snapshot = await getDocs(q);
                
                if (isInitialLoad) {
                    list.innerHTML = '';
                }

                if (snapshot.docs.length === 0 && isInitialLoad) {
                    list.innerHTML = `<div style="text-align: center; color: var(--light-text-color); margin-top: 20px;">${currentLang === 'vi' ? 'Ch∆∞a c√≥ tin nh·∫Øn n√†o.' : 'No messages yet.'}</div>`;
                    loadMoreBtn.style.display = 'none';
                    return;
                }
                
                const newMessages = [];
                const likedMessages = JSON.parse(localStorage.getItem('likedMessages12B2') || '{}');

                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const date = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : (currentLang === 'vi' ? 'V·ª´a xong' : 'Just now');
                    const authorDisplay = msg.author || translations[currentLang]['anonymous'];
                    const likes = msg.likes || 0;
                    const likedClass = likedMessages[doc.id] ? 'liked' : '';

                    newMessages.push(`
                        <div class="post card" data-doc-id="${doc.id}">
                            <div class="post-header">
                                <span class="post-author"><i class="fas fa-user-secret"></i> ${authorDisplay}</span>
                                <span>${date}</span>
                            </div>
                            <div style="font-size: 1rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word;">${msg.text}</div>
                            <div class="post-likes" onclick="toggleLike('${doc.id}', ${likes})">
                                <i class="fas fa-heart ${likedClass}"></i>
                                <span data-likes-count="${doc.id}">${likes}</span>
                            </div>
                        </div>`);
                });

                if (isInitialLoad) {
                    list.innerHTML = newMessages.join('');
                } else {
                    list.insertAdjacentHTML('beforeend', newMessages.join(''));
                }

                if (snapshot.docs.length > 0) {
                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                }

                if (snapshot.docs.length === MESSAGE_LIMIT) {
                    loadMoreBtn.style.display = 'block';
                    loadMoreBtn.textContent = translations[currentLang]['load_more_msg'];
                    loadMoreBtn.disabled = false;
                } else {
                    loadMoreBtn.style.display = 'none'; 
                }

            } catch (error) {
                console.error("L·ªói t·∫£i tin nh·∫Øn:", error);
                if (isInitialLoad) list.innerHTML = `<div style="text-align: center; color: var(--light-text-color); margin-top: 20px;">L·ªói t·∫£i tin nh·∫Øn.</div>`;
                loadMoreBtn.style.display = 'none';
            }
        }


        window.toggleLike = async function(docId, currentLikes) {
            const likesCountElement = document.querySelector(`[data-likes-count="${docId}"]`);
            const likeIcon = likesCountElement ? likesCountElement.previousElementSibling : null;
            
            if (!likesCountElement || !likeIcon) return;
            
            const likedMessages = JSON.parse(localStorage.getItem('likedMessages12B2') || '{}');
            const hasLiked = likedMessages[docId];
            
            let newLikes = currentLikes;

            if (!hasLiked) {
                newLikes = currentLikes + 1;
                likedMessages[docId] = true;
                likeIcon.classList.add('liked');
            } else {
                newLikes = Math.max(0, currentLikes - 1);
                delete likedMessages[docId];
                likeIcon.classList.remove('liked');
            }
            
            likesCountElement.textContent = newLikes;
            localStorage.setItem('likedMessages12B2', JSON.stringify(likedMessages));

            try {
                const docRef = doc(db, "anonymous_messages", docId);
                await updateDoc(docRef, {
                    likes: newLikes
                });
            } catch (error) {
                console.error("L·ªói c·∫≠p nh·∫≠t like:", error);
                // Ho√†n t√°c n·∫øu l·ªói
                if (!hasLiked) {
                    likesCountElement.textContent = currentLikes;
                    delete likedMessages[docId];
                    likeIcon.classList.remove('liked');
                } else {
                    likesCountElement.textContent = currentLikes;
                    likedMessages[docId] = true;
                    likeIcon.classList.add('liked');
                }
                localStorage.setItem('likedMessages12B2', JSON.stringify(likedMessages));
            }
        };


        window.sendMessage = async function() {
            const messageText = document.getElementById('message-text').value;
            const btn = document.getElementById('btn-send-msg');
            if (!messageText.trim()) return;

            btn.disabled = true;
            btn.innerText = currentLang === 'vi' ? "ƒêang g·ª≠i..." : "Sending...";

            try {
                await addDoc(chatRef, {
                    text: messageText,
                    createdAt: serverTimestamp(),
                    author: currentUserName || translations[currentLang]['anonymous'],
                    likes: 0
                });
                document.getElementById('message-text').value = '';
                
                await loadMoreMessages(true); 

            } catch (error) {
                console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
                alert((currentLang === 'vi' ? "L·ªói g·ª≠i tin nh·∫Øn: " : "Error sending message: ") + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = translations[currentLang]['send_msg'];
            }
        }
        
        // --- LOGIC TIC-TAC-TOE (C·ªú CARO) ---
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameActive = true;

        const cells = document.querySelectorAll('.cell');
        const statusDisplay = document.getElementById('tictactoe-status');
        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]           
        ];

        function updateGameStatusDisplay() {
            if (!gameActive) return; 
            const key = currentPlayer === 'X' ? 'tictactoe_status_x' : 'tictactoe_status_o';
            statusDisplay.textContent = translations[currentLang][key];
        }
        
        function handleResultValidation() {
            let roundWon = false;
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = board[winCondition[0]];
                let b = board[winCondition[1]];
                let c = board[winCondition[2]];

                if (a === '' || b === '' || c === '') continue;

                if (a === b && b === c) {
                    roundWon = true;
                    break;
                }
            }

            if (roundWon) {
                statusDisplay.textContent = translations[currentLang][currentPlayer === 'X' ? 'tictactoe_win_x' : 'tictactoe_win_o'];
                gameActive = false;
                return;
            }

            let roundDraw = !board.includes('');
            if (roundDraw) {
                statusDisplay.textContent = translations[currentLang]['tictactoe_draw'];
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            updateGameStatusDisplay();
        }

        function handleCellClick(clickedCellEvent) {
            const clickedCell = clickedCellEvent.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-index'));

            if (board[clickedCellIndex] !== '' || !gameActive) return;

            board[clickedCellIndex] = currentPlayer;
            clickedCell.textContent = currentPlayer;
            clickedCell.classList.add(currentPlayer.toLowerCase());

            handleResultValidation();
        }
        
        window.resetGame = function() {
            gameActive = true;
            currentPlayer = 'X';
            board = ['', '', '', '', '', '', '', '', ''];
            updateGameStatusDisplay();
            cells.forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('x', 'o');
            });
        }

        function initTicTacToe() {
            cells.forEach(cell => {
                cell.removeEventListener('click', handleCellClick); 
                cell.addEventListener('click', handleCellClick);
            });
            resetGame(); 
        }

        // --- LOGIC GAME ƒêO√ÅN S·ªê (NUMBER GUESSING) ---
        let secretNumber;
        let guessesLeft;
        const maxGuesses = 10;
        let guessingGameStatus = 'playing';

        window.startNewGuessingGame = function() {
            secretNumber = Math.floor(Math.random() * 100) + 1;
            guessesLeft = maxGuesses;
            guessingGameStatus = 'playing';

            document.getElementById('guess-result').textContent = translations[currentLang]['guessing_prompt'];
            document.getElementById('guess-result').className = '';
            document.getElementById('guess-log').innerHTML = translations[currentLang]['guess_try_left'].replace('%t', guessesLeft);
            document.getElementById('guess-input').value = '';
            document.getElementById('guess-input').disabled = false;
            document.getElementById('guess-button').disabled = false;
        }

        window.checkGuess = function() {
            if (guessingGameStatus !== 'playing') return;

            const inputElement = document.getElementById('guess-input');
            const guess = parseInt(inputElement.value);
            const resultElement = document.getElementById('guess-result');
            const logElement = document.getElementById('guess-log');

            if (isNaN(guess) || guess < 1 || guess > 100) {
                resultElement.textContent = translations[currentLang]['guess_input_invalid'];
                resultElement.className = 'lose';
                return;
            }

            guessesLeft--;

            if (guess === secretNumber) {
                resultElement.textContent = translations[currentLang]['guess_win'].replace('%s', secretNumber).replace('%t', maxGuesses - guessesLeft);
                resultElement.className = 'win';
                logElement.innerHTML = `‚úÖ ${guess} | ${logElement.innerHTML}`;
                guessingGameStatus = 'win';
                inputElement.disabled = true;
                document.getElementById('guess-button').disabled = true;

            } else {
                let hintKey = guess < secretNumber ? 'guess_too_low' : 'guess_too_high';
                let hint = translations[currentLang][hintKey];
                
                resultElement.textContent = hint;
                resultElement.className = 'lose';
                logElement.innerHTML = `‚ùå ${guess} (${hint}) <br> ${logElement.innerHTML}`;

                if (guessesLeft === 0) {
                    resultElement.textContent = translations[currentLang]['guess_lose'].replace('%s', secretNumber);
                    guessingGameStatus = 'lose';
                    inputElement.disabled = true;
                    document.getElementById('guess-button').disabled = true;
                } else {
                    logElement.innerHTML = ` (${translations[currentLang]['guess_try_left'].replace('%t', guessesLeft)}) <br> ${logElement.innerHTML}`;
                }
            }
            inputElement.value = '';
            inputElement.focus();
        }

        // --- LOGIC GAME GH√âP C·∫∂P (MEMORY MATCH) M·ªöI ---
        const MEMORY_ICONS = [
            '<i class="fas fa-apple-alt"></i>', '<i class="fas fa-bell"></i>', '<i class="fas fa-birthday-cake"></i>', '<i class="fas fa-cat"></i>', 
            '<i class="fas fa-camera"></i>', '<i class="fas fa-cookie"></i>', '<i class="fas fa-dog"></i>', '<i class="fas fa-feather"></i>'
        ];
        let cards = [];
        let flippedCards = [];
        let matchesFound = 0;
        let canFlip = true;
        let totalTurns = 0;
        const memoryStatus = document.getElementById('memory-status');

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.startMemoryGame = function(resetOnly = false) {
            if (resetOnly) {
                memoryStatus.textContent = translations[currentLang]['memory_status_start'];
                document.getElementById('memory-game-board').innerHTML = '';
                return;
            }

            totalTurns = 0;
            matchesFound = 0;
            canFlip = true;
            flippedCards = [];
            memoryStatus.textContent = translations[currentLang]['memory_status_turn'].replace('%t', totalTurns);

            const doubledIcons = [...MEMORY_ICONS, ...MEMORY_ICONS];
            cards = shuffleArray(doubledIcons);

            const board = document.getElementById('memory-game-board');
            board.innerHTML = '';

            cards.forEach((icon, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('memory-card');
                cardElement.dataset.icon = icon;
                cardElement.dataset.index = index;
                cardElement.innerHTML = `
                    <div class="card-face back-face"><i class="fas fa-question"></i></div>
                    <div class="card-face front-face">${icon}</div>
                `;
                cardElement.addEventListener('click', handleCardClick);
                board.appendChild(cardElement);
            });
        }

        function handleCardClick(event) {
            const clickedCard = event.currentTarget;

            if (!canFlip || flippedCards.includes(clickedCard) || clickedCard.classList.contains('match')) return;
            
            clickedCard.classList.add('flip');
            flippedCards.push(clickedCard);

            if (flippedCards.length === 2) {
                canFlip = false;
                totalTurns++;
                memoryStatus.textContent = translations[currentLang]['memory_status_turn'].replace('%t', totalTurns);

                const [card1, card2] = flippedCards;
                if (card1.dataset.icon === card2.dataset.icon) {
                    // Match Found!
                    matchesFound++;
                    setTimeout(() => {
                        card1.classList.add('match');
                        card2.classList.add('match');
                        flippedCards = [];
                        canFlip = true;
                        
                        if (matchesFound === MEMORY_ICONS.length) {
                            memoryStatus.textContent = translations[currentLang]['memory_status_win'];
                        }
                    }, 500);

                } else {
                    // No Match
                    setTimeout(() => {
                        card1.classList.remove('flip');
                        card2.classList.remove('flip');
                        flippedCards = [];
                        canFlip = true;
                    }, 1000);
                }
            }
        }


        // --- LOGIC QUIZ & LEADERBOARD (GI·ªÆ NGUY√äN) ---

        window.saveUserName = function() {
            const nameInput = document.getElementById('user-name-input').value.trim();
            if (nameInput.length < 2 || nameInput.length > 20) {
                alert(currentLang === 'vi' ? "T√™n ph·∫£i t·ª´ 2 ƒë·∫øn 20 k√Ω t·ª±!" : "Name must be between 2 and 20 characters!");
                return;
            }
            currentUserName = nameInput;
            localStorage.setItem('userName12B2', currentUserName);
            document.getElementById('current-user-display').innerText = currentUserName;
            document.getElementById('name-input-section').style.display = 'none';
            document.getElementById('quiz-section').style.display = 'block';
            initQuiz();
        }

        window.initQuiz = async function() {
            currentScore = 0;
            questionsAttempted = 0;
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('quiz-content').style.display = 'block';
            document.getElementById('quiz-complete').style.display = 'none';
            
            // Hi·ªÉn th·ªã skeleton loading
            document.getElementById('q-text').innerHTML = '<div class="skeleton skeleton-text-lg"></div>';
            document.getElementById('options').innerHTML = '<div class="skeleton skeleton-button"></div><div class="skeleton skeleton-button"></div><div class="skeleton skeleton-button"></div><div class="skeleton skeleton-button"></div>';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('q-category').innerText = translations[currentLang]['topic'];


            if (fullQuestionBank.length === 0) {
                try {
                    const querySnapshot = await getDocs(quizRef);
                    querySnapshot.forEach((doc) => { fullQuestionBank.push({ id: doc.id, ...doc.data() }); });
                    if (fullQuestionBank.length === 0) {
                        document.getElementById('q-text').innerText = currentLang === 'vi' ? "Ch∆∞a c√≥ c√¢u h·ªèi n√†o. Vui l√≤ng ƒë√≥ng g√≥p!" : "No questions yet. Please contribute!";
                        document.getElementById('options').innerHTML = '';
                        return;
                    }
                } catch (e) {
                    document.getElementById('q-text').innerText = currentLang === 'vi' ? "L·ªói k·∫øt n·ªëi ho·∫∑c ch∆∞a c√≥ c√¢u h·ªèi. Vui l√≤ng ki·ªÉm tra Rules Firestore." : "Connection error or no questions. Check Firestore Rules.";
                    document.getElementById('options').innerHTML = '';
                    return;
                }
            }

            const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]').map(item => item.id) || [];
            availableQuestions = fullQuestionBank.filter(q => !doneIds.includes(q.id));

            if(availableQuestions.length === 0) {
                localStorage.removeItem('quiz_done_ids');
                availableQuestions = fullQuestionBank;
            } 
            loadNextQuestion();
        }

        window.loadNextQuestion = function() {
            if(availableQuestions.length === 0) { 
                endQuizAndSubmitScore();
                return;
            }

            document.getElementById('next-btn').style.display = 'none';
            
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const qData = availableQuestions[randomIndex];
            
            document.getElementById('q-category').innerText = qData.cat || (currentLang === 'vi' ? 'Chung' : 'General');
            document.getElementById('q-text').innerText = qData.q;
            
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            
            qData.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = ans;
                btn.onclick = () => checkAnswer(btn, qData, idx); 
                optDiv.appendChild(btn);
            });
        }

        window.checkAnswer = function(btn, qData, selectedIdx) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true); 

            questionsAttempted++;

            if(selectedIdx === qData.c) {
                btn.classList.add('correct');
                currentScore += 10; 
                
                const doneIds = JSON.parse(localStorage.getItem('quiz_done_ids') || '[]') || [];
                if(!doneIds.some(item => item.id === qData.id)) {
                    doneIds.push({ id: qData.id, date: new Date().getTime() });
                    localStorage.setItem('quiz_done_ids', JSON.stringify(doneIds));
                }

            } else {
                btn.classList.add('wrong');
                allBtns[qData.c].classList.add('correct'); 
            }
            
            document.getElementById('current-score').innerText = currentScore;
            document.getElementById('done-count').innerText = questionsAttempted;
            document.getElementById('next-btn').style.display = 'inline-block';
            
            availableQuestions = availableQuestions.filter(q => q.id !== qData.id);
        }

        function endQuizAndSubmitScore() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('quiz-complete').style.display = 'block';
            document.getElementById('final-score-display').innerText = currentScore;
            
            saveScoreToLeaderboard(currentScore, questionsAttempted);
        }
        
        async function saveScoreToLeaderboard(score, attempts) {
            if (!currentUserName || score === 0) return; 

            try {
                await addDoc(leaderboardRef, {
                    name: currentUserName,
                    score: score,
                    attempts: attempts,
                    createdAt: serverTimestamp()
                });
                loadLeaderboard(); 
            } catch (error) {
                console.error("L·ªói l∆∞u BXH:", error);
            }
        }

        window.loadLeaderboard = async function() {
            const q = query(leaderboardRef, orderBy("score", "desc"), limit(10)); 
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString(currentLang === 'vi' ? 'vi-VN' : 'en-US') : 'N/A';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${rank++}</td>
                        <td>${data.name}</td>
                        <td>${data.score}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });

            if (snapshot.empty) {
                 tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${currentLang === 'vi' ? 'Ch∆∞a c√≥ ai tham gia!' : 'No one has played yet!'}</td></tr>`;
            }
        }

        window.resetQuiz = function() {
            questionsAttempted = 0;
            currentScore = 0;
            localStorage.removeItem('quiz_done_ids'); 
            initQuiz();
        }

        window.submitUserQuestion = async function() {
            const qText = document.getElementById('q-text-input').value.trim();
            const ans0 = document.getElementById('q-ans-0').value.trim();
            const ans1 = document.getElementById('q-ans-1').value.trim();
            const ans2 = document.getElementById('q-ans-2').value.trim();
            const ans3 = document.getElementById('q-ans-3').value.trim();
            const correctIdx = parseInt(document.getElementById('q-correct-select').value);
            const category = document.getElementById('q-cat-input').value.trim() || (currentLang === 'vi' ? 'C·ªông ƒë·ªìng' : 'Community');
            const submitButton = document.querySelector('#create-question-section button.btn-send');

            if (!qText || !ans0 || !ans1 || !ans2 || !ans3 || correctIdx === -1) {
                return alert(currentLang === 'vi' ? "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung c√¢u h·ªèi, 4 ƒë√°p √°n v√† ch·ªçn ƒë√°p √°n ƒë√∫ng." : "Please fill in all question content, 4 answers, and select the correct answer.");
            }
            
            submitButton.disabled = true;
            submitButton.textContent = currentLang === 'vi' ? "ƒêang x·ª≠ l√Ω..." : "Processing...";


            try {
                await addDoc(quizRef, { 
                    q: qText, 
                    a: [ans0, ans1, ans2, ans3], 
                    c: correctIdx, 
                    cat: category,
                    submittedBy: currentUserName || translations[currentLang]['anonymous'],
                    createdAt: serverTimestamp(),
                });

                alert(currentLang === 'vi' ? "C√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c th√™m v√†o Quiz ngay l·∫≠p t·ª©c! C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p." : "Question has been added to the Quiz immediately! Thank ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p.");
                
                fullQuestionBank = []; 
                await initQuiz(); 

                document.getElementById('q-text-input').value = '';
                document.getElementById('q-ans-0').value = '';
                document.getElementById('q-ans-1').value = '';
                document.getElementById('q-ans-2').value = '';
                document.getElementById('q-ans-3').value = '';
                document.getElementById('q-correct-select').value = '-1';
                document.getElementById('q-cat-input').value = '';

            } catch (error) {
                console.error("L·ªói g·ª≠i c√¢u h·ªèi:", error);
                alert((currentLang === 'vi' ? "L·ªói g·ª≠i c√¢u h·ªèi: " : "Error submitting question: ") + error.message);
            } finally {
                 submitButton.disabled = false;
                 submitButton.textContent = translations[currentLang]['submit_q'];
            }
        }
        
    </script>
</body>
</html>